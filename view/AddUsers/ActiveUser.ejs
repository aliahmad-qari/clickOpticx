<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Active Users</title>
  <!-- plugins:css -->
  <link rel="stylesheet" href="vendors/feather/feather.css">
  <link rel="stylesheet" href="vendors\ti-icons\css\themify-icons.css">
  <link rel="stylesheet" href="vendors/css/vendor.bundle.base.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <!-- endinject -->
  <!-- Plugin css for this page -->
  <link rel="stylesheet" href="vendors/datatables.net-bs4/dataTables.bootstrap4.css">
  <link rel="stylesheet" href="vendors\ti-icons\css\themify-icons.css">
  <link rel="stylesheet" type="text/css" href="js/select.dataTables.min.css">
  <!-- End plugin css for this page -->
  <!-- inject:css -->
  <link rel="stylesheet" href="css/vertical-layout-light/style.css">
  <!-- endinject -->
  <link rel="shortcut icon" href="images/favicon.png" />

  <!-- Material Design Icons CSS -->
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<style>
  :root {
    --primary: #6c5ce7;
    --primary-light: #a29bfe;
  }

  .ag-courses_box {
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    -webkit-box-align: start;
    -ms-flex-align: start;
    align-items: flex-start;
    -ms-flex-wrap: wrap;
    flex-wrap: wrap;

    padding: 50px 0;
  }

  .ag-courses_item {
    -ms-flex-preferred-size: calc(33.33333% - 30px);
    flex-basis: calc(33.33333% - 30px);

    margin: 0 15px 30px;

    overflow: hidden;

    border-radius: 28px;
  }

  .ag-courses-item_link {
    display: block;
    padding: 30px 20px;
    background-color: #121212;

    overflow: hidden;

    position: relative;
  }

  .ag-courses-item_link:hover,
  .ag-courses-item_link:hover .ag-courses-item_date {
    text-decoration: none;
    color: #FFF;
  }

  .ag-courses-item_link:hover .ag-courses-item_bg {
    -webkit-transform: scale(10);
    -ms-transform: scale(10);
    transform: scale(10);
  }

  .ag-courses-item_title {
    min-height: 87px;
    margin: 0 0 25px;
    text-align: center;
    overflow: hidden;

    font-weight: bold;
    font-size: 30px;
    color: #FFF;

    z-index: 2;
    position: relative;
  }

  .ag-courses-item_date-box {
    font-size: 16px;
    color: #FFF;
    gap: 11px;
    justify-content: center;
    z-index: 2;
    position: relative;
  }

  .ag-courses-item_date {
    font-weight: bold;
    color: #f9b234;

    -webkit-transition: color .5s ease;
    -o-transition: color .5s ease;
    transition: color .5s ease
  }

  .ag-courses-item_bg {
    height: 128px;
    width: 128px;
    background-color: #f9b234;

    z-index: 1;
    position: absolute;
    top: -75px;
    right: -75px;

    border-radius: 50%;

    -webkit-transition: all .5s ease;
    -o-transition: all .5s ease;
    transition: all .5s ease;
  }

  .ag-courses_item:nth-child(2n) .ag-courses-item_bg {
    background-color: #3ecd5e;
  }

  .ag-courses_item:nth-child(3n) .ag-courses-item_bg {
    background-color: #e44002;
  }

  .ag-courses_item:nth-child(4n) .ag-courses-item_bg {
    background-color: #952aff;
  }

  .ag-courses_item:nth-child(5n) .ag-courses-item_bg {
    background-color: #cd3e94;
  }

  .ag-courses_item:nth-child(6n) .ag-courses-item_bg {
    background-color: #4c49ea;
  }

  @media only screen and (max-width: 979px) {
    .ag-courses_item {
      -ms-flex-preferred-size: calc(50% - 30px);
      flex-basis: calc(50% - 30px);
    }

    .ag-courses-item_title {
      font-size: 24px;
    }
  }

  @media only screen and (max-width: 767px) {
    .ag-format-container {
      width: 96%;
    }
  }

  @media only screen and (max-width: 639px) {
    .ag-courses_item {
      -ms-flex-preferred-size: 100%;
      flex-basis: 100%;
    }

    .ag-courses-item_title {
      min-height: 72px;
      line-height: 1;

      font-size: 24px;
    }

    .ag-courses-item_link {
      padding: 22px 40px;
    }

    .ag-courses-item_date-box {
      font-size: 16px;
    }
  }

  .main-b {
    background: linear-gradient(90deg, var(--primary), var(--primary-light));
    color: white;
    padding: 20px 25px;
    font-size: 1.4rem;
    width: 98%;
    border-radius: 10px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .search-container {
    margin: 25px 0;
    width: 98%;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: flex-end;
    gap: 20px;
    background-color: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
  }

  .search-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .input-label {
    font-size: 17px;
    font-weight: 700;
    color: #8073f0;
  }

  .search-input,
  .date-input {
    width: 100%;
    max-width: 250px;
    padding: 10px 15px;
    border-radius: 6px;
    border: 1px solid #ced4da;
    font-size: 14px;
    outline: none;
    transition: all 0.3s ease;
    background-color: white;
  }

  .date-range-group {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .date-separator {
    color: #6c757d;
    font-size: 14px;
  }

  .search-input:focus,
  .date-input:focus {
    border-color: var(--primary-light);
    box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.15);
  }

  /* Modern date input styling */
  .date-input::-webkit-calendar-picker-indicator {
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.2s;
  }

  .date-input::-webkit-calendar-picker-indicator:hover {
    opacity: 1;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .search-container {
      flex-direction: column;
      align-items: stretch;
    }

    .search-input,
    .date-input {
      max-width: 60%;
    }

    .date-range-group {
      justify-content: space-between;
      width: 50%;
    }
  }
</style>

<body>
  <div class="container-scroller">
    <%- include ('../partials/_navbar.ejs') %>
      <!-- partial -->
      <div class="container-fluid page-body-wrapper" style="padding-left:0% !important;">
        <!-- partial:partials/_settings-panel.html -->
        <%- include ('../partials/SettingsDow.ejs') %>

          <!-- NavBar Start -->
          <%- include ('../partials/Sidebar.ejs') %>
            <!-- NavBar End -->

            <div class="card col-md-10 col-lg-10 mx-auto" style="background-color: #F3F3F9;">
              <!-- Success Message -->
              <% if (messages.success) { %>
                <div style="display: flex; justify-content: end;">
                  <div id="pusher-message-box" style="
            display: flex;
            border-left: 8px solid #45439e;
            color: green;
            font-weight: bold;
            font-size: 16px;
            justify-content: end;
            align-items: center;
            height: 70px;
          " class="mt-3 alert alert-primary">
                    <%= messages.success %>
                  </div>
                </div>
                <% } %>
                  <script>
                    window.addEventListener('DOMContentLoaded', () => {
                      const msgBox = document.getElementById('pusher-message-box');
                      if (msgBox) {
                        setTimeout(() => {
                          msgBox.style.transition = "opacity 0.5s";
                          msgBox.style.opacity = 0;
                          setTimeout(() => msgBox.style.display = "none", 500);
                        }, 4000);
                      }
                    });
                  </script>
                  <!-- End Success Message -->

                  <div class="main-b">
                    <h4 class="main-h" style="font-size: 28px;">Active Users</h4>
                  </div>

                  <!-- Search and Date Filter -->
                  <div class="search-container">
                    <div class="search-group">
                      <label for="usernameSearch" class="input-label">Username</label>
                      <input type="text" id="usernameSearch" class="search-input" placeholder="Enter username...">
                    </div>

                    <div class="search-group">
                      <label for="startDate" class="input-label">Date Range</label>
                      <div class="date-range-group">
                        <input type="date" id="startDate" class="date-input">
                        <span class="date-separator">to</span>
                        <input type="date" id="endDate" class="date-input">
                      </div>
                    </div>
                  </div>
                  <!-- Search and Date Filter -->


                  <div class="ag-format-container">
                    <div class="ag-courses_box">
                      <% user.forEach(users=> { %>
                        <div class="ag-courses_item">
                          <a href="#" class="ag-courses-item_link">
                            <div class="ag-courses-item_bg"></div>
                            <div class="ag-courses-item_title">
                              <img
                                src="<%= users.user_img ? '/Uploads/' + users.user_img : '/images/profile-1740414577370.webp' %>"
                                class="profile-img mx-auto d-block"
                                style="width: 80px; height: 80px; object-fit: cover; border-radius: 50%;">
                              <%= users.Username %>
                            </div>

                            <div class="ag-courses-item_date-box gap-1">
                              <strong>Status:</strong>
                              <span class="ag-courses-item_date">
                                <%= users.invoice %>
                              </span><br>

                              <strong>Package:</strong>
                              <span class="ag-courses-item_date">
                                <%= users.plan %> GB
                              </span><br>

                              <% if (users.latest_payment) { %>
                                <strong>Active Date:</strong>
                                <span class="ag-courses-item_date active-date">
                                  <%= users.latest_payment %>
                                </span>
                                <% } else { %>
                                  <span class="ag-courses-item_date text-muted active-date">No Payments Found</span>
                                  <% } %>
                            </div>
                          </a>
                        </div>
                        <% }) %>
                    </div>
                  </div>
            </div>
            <!-- All User Table End -->
            <script>
              // Username search filter
              function filterByUsername() {
                const searchInput = document.getElementById('usernameSearch').value.toLowerCase();
                const userCards = document.querySelectorAll('.ag-courses_item');

                userCards.forEach(card => {
                  const username = card.querySelector('.ag-courses-item_title').textContent.toLowerCase().trim();
                  if (username.includes(searchInput)) {
                    card.classList.remove('hidden-by-username');
                  } else {
                    card.classList.add('hidden-by-username');
                    card.style.display = 'none';
                  }
                });

                // Re-apply date filter to ensure compatibility
                filterTableByDateRange();
              }

              // Date range filter
              function filterTableByDateRange() {
                const startDateInput = document.getElementById('startDate').value;
                const endDateInput = document.getElementById('endDate').value;
                const userCards = document.querySelectorAll('.ag-courses_item');

                // If no dates are selected, show all cards (subject to username filter)
                if (!startDateInput && !endDateInput) {
                  userCards.forEach(card => {
                    if (!card.classList.contains('hidden-by-username')) {
                      card.style.display = '';
                    }
                  });
                  return;
                }

                const startDate = startDateInput ? new Date(startDateInput) : null;
                const endDate = endDateInput ? new Date(endDateInput) : null;

                // Validate date range
                if (startDate && endDate && endDate < startDate) {
                  alert('End date cannot be before start date.');
                  return;
                }

                userCards.forEach(card => {
                  const activeDateText = card.querySelector('.active-date').textContent.trim();
                  if (activeDateText === 'No Payments Found') {
                    card.style.display = 'none';
                    return;
                  }

                  // Parse the active date from format "dd-mm-yyyy" (e.g., 03-06-2025)
                  const [day, month, year] = activeDateText.split('-').map(Number);
                  const activeDate = new Date(year, month - 1, day); // month is 0-based in JS

                  // Show card if active date falls within the range (or if one date is not set)
                  const isAfterStart = !startDate || activeDate >= startDate;
                  const isBeforeEnd = !endDate || activeDate <= endDate;
                  card.style.display = isAfterStart && isBeforeEnd && !card.classList.contains('hidden-by-username') ? '' : 'none';
                });
              }

              // Add event listeners
              document.getElementById('usernameSearch').addEventListener('input', filterByUsername);
              document.getElementById('startDate').addEventListener('change', filterTableByDateRange);
              document.getElementById('endDate').addEventListener('change', filterTableByDateRange);

              // Run filter on page load
              filterTableByDateRange();
            </script>
            <!-- plugins:js -->
            <script src="vendors\js\vendor.bundle.base.js"></script>
            <!-- endinject -->
            <!-- Plugin js for this page -->
            <script src="vendors\chart.js/Chart.min.js"></script>
            <script src="vendors/datatables.net/jquery.dataTables.js"></script>
            <script src="vendors/datatables.net-bs4/dataTables.bootstrap4.js"></script>
            <script src="js/dataTables.select.min.js"></script>
            <!-- End plugin js for this page -->
            <!-- inject:js -->
            <script src="js/off-canvas.js"></script>
            <script src="js/hoverable-collapse.js"></script>
            <script src="js/template.js"></script>
            <script src="js/settings.js"></script>
            <!-- endinject -->
            <!-- Custom js for this page-->
            <script src="js/dashboard.js"></script>
            <script src="js/Chart.roundedBarCharts.js"></script>
            <!-- End custom js for this page-->
            <!-- Bootstrap  -->
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
            <script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
      </div>
  </div>
</body>

</html>