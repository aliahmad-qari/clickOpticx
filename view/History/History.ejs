<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>History</title>
    <link rel="stylesheet" href="vendors/feather/feather.css">
    <link rel="stylesheet" href="vendors/ti-icons/css/themify-icons.css">
    <link rel="stylesheet" href="vendors/css/vendor.bundle.base.css">
    <!-- Plugin css for this page -->
    <link rel="stylesheet" href="vendors/datatables.net-bs4/dataTables.bootstrap4.css">
    <link rel="stylesheet" type="text/css" href="js/select.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <link rel="stylesheet" href="css/vertical-layout-light/style.css">
    <!-- endinject -->
    <link rel="shortcut icon" href="images/favicon.png" />
    <!-- Material Design Icons CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

  <style>
    /* Global Theme Variables */
    :root {
      /* Brand Colors - Same for both themes */
      --primary-color: #4F46E5;
      --primary-dark: #3730A3;
      --primary-light: #8B5CF6;
      --secondary-color: #10B981;
      --secondary-dark: #059669;
      --accent-color: #F59E0B;
      --accent-dark: #D97706;
      --danger-color: #EF4444;
      --success-color: #22C55E;
      --warning-color: #F59E0B;
      --info-color: #3B82F6;

      /* Light Theme Colors */
      --bg-primary: #FFFFFF;
      --bg-secondary: #F8FAFC;
      --bg-tertiary: #F1F5F9;
      --text-primary: #1E293B;
      --text-secondary: #475569;
      --text-tertiary: #64748B;
      --border-primary: #E2E8F0;
      --border-secondary: #CBD5E1;
      --shadow-light: rgba(0, 0, 0, 0.1);
      --shadow-medium: rgba(0, 0, 0, 0.15);
      --shadow-heavy: rgba(0, 0, 0, 0.25);
      --card-bg: #FFFFFF;
      --navbar-bg: #FFFFFF;
      --sidebar-bg: #FFFFFF;
    }

    /* Dark Theme Colors */
    [data-theme="dark"] {
      --bg-primary: #0F172A;
      --bg-secondary: #1E293B;
      --bg-tertiary: #334155;
      --text-primary: #F8FAFC;
      --text-secondary: #CBD5E1;
      --text-tertiary: #94A3B8;
      --border-primary: #334155;
      --border-secondary: #475569;
      --shadow-light: rgba(0, 0, 0, 0.3);
      --shadow-medium: rgba(0, 0, 0, 0.4);
      --shadow-heavy: rgba(0, 0, 0, 0.6);
      --card-bg: #1E293B;
      --navbar-bg: #0F172A;
      --sidebar-bg: #1E293B;
    }

    /* Legacy compatibility */
    :root {
      --primary: var(--primary-color);
      --primary-light: var(--primary-light);
      --secondary: var(--secondary-color);
      --success: var(--success-color);
      --success-light: var(--success-color);
      --warning: var(--warning-color);
      --danger: var(--danger-color);
      --dark: var(--text-primary);
      --light: var(--bg-secondary);
      --gray: var(--border-primary);
      --card-bg: var(--card-bg);
      --glass-effect: rgba(255, 255, 255, 0.15);
    }

    body {
      background: var(--bg-secondary) !important;
      color: var(--text-primary) !important;
      transition: all 0.3s ease;
    }
    /* Removed - consolidated into comprehensive mobile CSS below */


    .container-fluid.page-body-wrapper {
      display: flex;
      flex-direction: row;
    }

    .main-panel {
      flex-grow: 1;
      padding: 10px;
      transition: margin-left 0.3s ease;
    }

    @media (max-width: 991px) {
      .main-panel {
        margin-left: 0;
      }
    }

    .card {
      background: var(--card-bg) !important;
      border-radius: 12px;
      box-shadow: 0 4px 24px var(--shadow-light);
      border: 1px solid var(--border-primary) !important;
      overflow: hidden;
      margin-bottom: 30px;
      color: var(--text-primary) !important;
    }

    .card-header {
      background: linear-gradient(90deg, var(--primary), var(--primary-light));
      color: white;
      padding: 20px 25px;
      font-size: 1.4rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .card-body {
      padding: 25px;
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }
    /* Removed - consolidated into comprehensive mobile CSS below */


    .search-box {
      position: relative;
      flex: 1;
      min-width: 250px;
      max-width: 400px;
    }

    .search-box i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-tertiary);
    }

    .search-input {
      width: 100%;
      padding: 12px 15px 12px 45px;
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary-color);
      background-color: var(--card-bg);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .filter-options {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .form-select {
      padding: 10px 15px;
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      font-size: 0.95rem;
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
      cursor: pointer;
    }

    .btn-add {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(79, 70, 229, 0.2);
    }

    .btn-add:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }

    .table-responsive {
      overflow-x: auto;
      border-radius: 10px;
      background: var(--card-bg);
      box-shadow: 0 2px 8px var(--shadow-light);
    }

    
.equipment-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
}

@media (min-width: 768px) {
  .equipment-table {
    min-width: 800px;
  }
}

    .equipment-table th {
      background-color: var(--bg-tertiary);
      color: var(--primary-color);
      font-weight: 600;
      padding: 16px 20px;
      text-align: left;
      border-bottom: 1px solid var(--border-primary);
      white-space: nowrap;
    }

    .equipment-table td {
      padding: 14px 20px;
      border-bottom: 1px solid var(--border-primary);
      vertical-align: middle;
      color: var(--text-primary);
    }
    .equipment-table td,
.equipment-table th {
  word-break: break-word;
}


    .equipment-table tr:hover {
      background-color: var(--bg-tertiary);
    }
    
    /* Fix dark mode hover visibility */
    [data-theme="dark"] .equipment-table tr:hover {
      background-color: var(--bg-tertiary) !important;
      color: var(--text-primary) !important;
    }
    
    [data-theme="dark"] .equipment-table tr:hover td {
      color: var(--text-primary) !important;
    }
    
    [data-theme="dark"] .equipment-table tr:hover .badge,
    [data-theme="dark"] .equipment-table tr:hover .status-badge {
      color: var(--text-primary) !important;
      background-color: var(--bg-primary) !important;
      border: 1px solid var(--text-primary) !important;
      opacity: 1;
    }
    
    [data-theme="dark"] .equipment-table tr:hover .package-name,
    [data-theme="dark"] .equipment-table tr:hover .package-name strong,
    [data-theme="dark"] .equipment-table tr:hover small {
      color: var(--text-primary) !important;
    }
    
    [data-theme="dark"] .equipment-table tr:hover .category-badge,
    [data-theme="dark"] .equipment-table tr:hover .progress-text {
      color: var(--text-primary) !important;
    }

    .equipment-image {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      object-fit: cover;
    }

    .category-badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      background-color: #e8f0fe;
      color: #1a73e8;
      font-weight: 500;
    }

    .quantity-display {
      position: relative;
      width: 80px;
    }

    .quantity-value {
      position: relative;
      z-index: 2;
      font-weight: 500;
    }

    .quantity-bar {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      background-color: rgba(66, 133, 244, 0.1);
      border-radius: 4px;
      z-index: 1;
      transition: width 0.5s ease;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
      white-space: nowrap;
    }

    .status-badge i {
      margin-right: 5px;
      font-size: 0.9rem;
    }

    .in-stock {
      background-color: rgba(52, 168, 83, 0.1);
      color: #34a853;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
    }
    /* Removed - consolidated into comprehensive mobile CSS below */


    .btn-action {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background-color: transparent;
      color: #5f6368;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-action:hover {
      background-color: #f1f3f4;
      color: #1a73e8;
    }

    .btn-action.edit:hover {
      background-color: #fff8e1;
      color: #f9ab00;
    }

    /* Modal Styling */
    .modal {
      z-index: 1055;
    }
   
  .custom-modal-height {
    max-height: 95vh; /* You can increase or decrease as needed */
  }

  .custom-modal-height .modal-content {
    max-height: 90vh;
    overflow-y: auto;
  }
  .modal-content{
    height: 100%;
  }


    .modal-backdrop {
      z-index: 1050;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-backdrop.show {
      opacity: 0.5;
    }

    .form-card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 10px 17px;
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      animation: slideUp 0.8s ease forwards;
      max-width: 700px;
      margin: 0 auto;
    }
    /* Removed - consolidated into comprehensive mobile CSS below */


    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(50px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .form-header {
      background: linear-gradient(90deg, var(--primary), var(--primary-light));
      color: white;
      padding: 12px;
      border-radius: 15px;
      text-align: center;
      margin-bottom: 30px;
      font-size: 23px;
      font-weight: 600;

      position: relative;
      overflow: hidden;
    }

    .form-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: linear-gradient(145deg, transparent 4px, rgba(0,0,0,0.2), transparent);
      animation: shine 2s infinite;
    }

    @keyframes shine {
      from {
        left: -100%;
      }

      to {
        left: 100%;
      }
    }

    .form-group {
      position: relative;
      margin-bottom: 30px;
    }

    .form-control,
    .form-select {
      width: 100%;
      border: none;
      border-bottom: 2px solid var(--gray);
      background: transparent;
      padding: 12px 0;
      font-size: 1rem;
      color: var(--dark);
      transition: all 0.3s ease;
    }

    .form-control:focus,
    .form-select:focus {
      border-bottom-color: var(--primary);
      outline: none;
    }

    .form-label {
      position: absolute;
      top: 12px;
      left: 0;
      font-weight: 500;
      color: black;
      pointer-events: none;
      transition: all 0.3s ease;
    }

    .form-control:focus~.form-label,
    .form-control:not(:placeholder-shown)~ .form-label,
      .form-select:focus~ .form-select:not([value=""])~.form-label {
      top: -20px;
      left: 0;
      font-size: 0.85rem;
      color: var(--primary);
    }

    .form-control:focus~.form-label::after,
    .form-control:not(:placeholder-shown)~ .form-label::after,
      .form-select:focus~ .form-select:not([value=""])~.form-label::after {
      content: '*';
      color: var(--danger);
      color: red;
      margin-left: 5px;
    }

    .form-select option {
      background: var(--light);
      color: var(--dark);
    }

    .btn-success {
      background: linear-gradient(145deg, var(--success), var(--success-light));
      color: white;
      border-radius: none;
      padding: 9px;
      border-radius: 50px;
      font-weight: bold;
      color: white;
      width: 100%;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: auto;
    }

    .btn-success:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(108, 92, 231, 0.3);
    }

    .btn-success::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      animation: shine 2s infinite;
    }

    .error-message {
      color: var(--danger);
      font-size: 0.85rem;
      margin-top: 5px;
      display: none;
    }

    .input-error .error-message {
      display: block;
    }

    .input-error .form-control,
    .form-control .input-error .form-select {
      border-color: var(--danger);
    }

    .form-icon {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
      transition: color 0.3s ease;
    }

    .form-control:focus~.form-icon,
    .form-select:focus~.form-icon {
      color: var(--primary);
    }

    /* Table Footer */
    .table-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding: 15px 10px;
      font-size: 0.9rem;
      color: #5f6368;
    }

    .showing-entries {
      color: #5f6368;
    }

    .pagination {
      display: flex;
      gap: 5px;
    }

    .page-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #e0e0e0;
      background-color: white;
      color: #5f6368;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
    }

    .page-btn:hover {
      background-color: #f1f3f4;
    }

    .page-btn.active {
      background-color: #1a73e8;
      color: white;
      border-color: #1a73e8;
    }

    .page-btn.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    /* Removed - consolidated into comprehensive mobile CSS below */

    .equipment-info {
      border: 0px solid #cccccc00;
      border-radius: 6px;
      display: inline-block;
    }

    .equipment-info:focus,
    .equipment-info:active,
    .equipment-info:focus-within {
      border: 0px solid #cccccc00;
      outline: none;
    }
    /* Removed - consolidated into comprehensive mobile CSS below */


    /* Print-specific styles */
    @media print {
      .no-print {
        display: none !important;
      }
    }
    html {
  font-size: 100%;
}

/* Removed - consolidated into comprehensive mobile CSS below */

/* Toast Messages */
.toast-message {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 15px 20px;
  border-radius: 8px;
  color: white;
  font-weight: 500;
  z-index: 10000;
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  animation: slideInRight 0.3s ease;
}

.toast-message.success {
  background: linear-gradient(135deg, #22c55e, #16a34a);
}

.toast-message.error {
  background: linear-gradient(135deg, #ef4444, #dc2626);
}

@keyframes slideInRight {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* Enhanced Action Buttons */
.action-buttons .btn {
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.action-buttons .btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.action-buttons .btn-outline-danger:hover {
  background-color: #dc2626;
  border-color: #dc2626;
  color: white;
}

.action-buttons .btn-outline-success:hover {
  background-color: #16a34a;
  border-color: #16a34a;
  color: white;
}

.action-buttons .btn:disabled {
  opacity: 0.7;
  cursor: not-allowed;
  transform: none;
}

/* Professional Table Design */
.equipment-table {
  box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
}

.equipment-table thead th {
  background: linear-gradient(135deg, #f8fafc, #e2e8f0);
  color: #1e293b;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 2px solid var(--primary-color);
}

.equipment-table tbody tr {
  transition: all 0.2s ease;
}

.equipment-table tbody tr:hover {
  background: linear-gradient(135deg, #f1f5f9, #f8fafc);
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

/* Enhanced Badges */
.category-badge {
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  color: white;
  font-weight: 600;
  padding: 8px 16px;
  border-radius: 20px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
}

.badge[style*="background-color: #dcf1e2"] {
  background: linear-gradient(135deg, #22c55e, #16a34a) !important;
  color: white !important;
  font-weight: 600;
  padding: 6px 12px;
  border-radius: 16px;
  box-shadow: 0 2px 6px rgba(34, 197, 94, 0.3);
}

.badge[style*="background-color: #fff3cd"] {
  background: linear-gradient(135deg, #f59e0b, #d97706) !important;
  color: white !important;
  font-weight: 600;
  padding: 6px 12px;
  border-radius: 16px;
  box-shadow: 0 2px 6px rgba(245, 158, 11, 0.3);
}

.badge[style*="background-color: #f8d7da"] {
  background: linear-gradient(135deg, #ef4444, #dc2626) !important;
  color: white !important;
  font-weight: 600;
  padding: 6px 12px;
  border-radius: 16px;
  box-shadow: 0 2px 6px rgba(239, 68, 68, 0.3);
}

/* Enhanced Card Header */
.card-header {
  background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
  position: relative;
}

.card-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
  animation: shimmer 3s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

/* Filter and Search Enhancement */
.header-actions {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 10px;
  padding: 10px 15px;
  backdrop-filter: blur(10px);
}

.header-actions input {
  background: rgba(255, 255, 255, 0.9);
  border: none;
  border-radius: 8px;
  padding: 8px 12px;
  color: var(--text-primary);
}

.header-actions button {
  background: rgba(255, 255, 255, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  border-radius: 8px;
  padding: 8px 15px;
  font-weight: 500;
  transition: all 0.3s ease;
}

.header-actions button:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: translateY(-1px);
}

/* Professional Loading States */
.btn .fa-spinner {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* Enhanced Empty State */
.text-center .fa-inbox {
  color: #cbd5e1;
  margin-bottom: 20px;
}

.text-center h5 {
  color: #475569;
  font-weight: 600;
  margin-bottom: 10px;
}

.text-center p {
  color: #64748b;
  font-size: 0.95rem;
}

/* Package Info Cell Styling */
.package-info-cell {
  padding: 8px 0;
  transition: all 0.2s ease;
}

.package-info-cell:hover {
  transform: scale(1.02);
}

.package-name {
  font-size: 1rem;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
}

.package-name i {
  font-size: 0.9rem;
}

/* Progress Container */
.progress-container {
  min-width: 120px;
}

.progress {
  border-radius: 10px;
  overflow: hidden;
  box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
}

.progress-bar {
  border-radius: 10px;
  transition: width 0.6s ease;
  background: linear-gradient(90deg, #3b82f6, #1d4ed8);
  position: relative;
  overflow: hidden;
}

.progress-bar::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.3) 50%, transparent 70%);
  animation: progressShimmer 2s infinite;
}

@keyframes progressShimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

/* Status Badge Enhancements */
.status-badge {
  font-size: 0.8rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: inline-flex;
  align-items: center;
  min-width: 80px;
  justify-content: center;
}

.status-badge.paid {
  animation: pulseSuccess 2s infinite;
}

.status-badge.due {
  animation: pulseWarning 2s infinite;
}

@keyframes pulseSuccess {
  0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
  70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
  100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
}

@keyframes pulseWarning {
  0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
  70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
  100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
}

/* Action Buttons Enhancement */
.action-buttons {
  display: flex;
  gap: 8px;
  justify-content: center;
}

.action-buttons .btn {
  border: 2px solid;
  font-weight: 500;
  position: relative;
  overflow: hidden;
}

.action-buttons .btn::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.3);
  transition: all 0.3s ease;
  transform: translate(-50%, -50%);
}

.action-buttons .btn:hover::before {
  width: 100%;
  height: 100%;
}

/* ===== COMPREHENSIVE MOBILE RESPONSIVENESS ===== */

/* Tablet - Large Mobile (768px and down) */
@media (max-width: 768px) {
  .container-fluid.page-body-wrapper {
    padding: 0 10px;
  }
  
  .main-panel {
    padding: 10px;
  }
  
  .card {
    margin-bottom: 15px;
    border-radius: 8px;
  }
  
  .card-header {
    padding: 15px 20px;
    font-size: 1.2rem;
    flex-direction: column;
    gap: 10px;
  }
  
  .header-actions {
    width: 100%;
    flex-direction: column;
    gap: 8px;
  }
  
  .header-actions input,
  .header-actions button {
    width: 100%;
    font-size: 0.9rem;
  }
  
  /* Table Improvements */
  .table-responsive {
    border-radius: 8px;
    margin: 0 -10px;
    padding: 0 10px;
  }
  
  .equipment-table {
    font-size: 0.85rem;
    min-width: 600px; /* Allow horizontal scroll for complex data */
  }
  
  .equipment-table th,
  .equipment-table td {
    padding: 8px 6px;
    vertical-align: top;
  }
  
  .equipment-table th {
    font-size: 0.75rem;
    white-space: nowrap;
  }
  
  /* Package Info Adjustments */
  .package-name {
    font-size: 0.85rem;
    margin-bottom: 2px;
  }
  
  .package-info-cell small {
    font-size: 0.7rem;
  }
  
  /* Progress Container */
  .progress-container {
    min-width: 80px;
  }
  
  .category-badge {
    font-size: 0.7rem;
    padding: 4px 8px;
  }
  
  /* Status Badge */
  .status-badge {
    font-size: 0.65rem;
    min-width: 60px;
    padding: 3px 6px;
  }
  
  /* Action Buttons */
  .action-buttons {
    flex-direction: row;
    gap: 4px;
    justify-content: center;
  }
  
  .action-buttons .btn {
    width: 32px;
    height: 32px;
    font-size: 0.8rem;
  }
}

/* Mobile - Standard (576px and down) */
@media (max-width: 576px) {
  body {
    font-size: 14px;
  }
  
  .container-fluid.page-body-wrapper {
    padding: 0 5px;
  }
  
  .main-panel {
    padding: 5px;
  }
  
  .card {
    border-radius: 6px;
    margin-bottom: 10px;
  }
  
  .card-header {
    padding: 12px 15px;
    font-size: 1.1rem;
  }
  
  .card-body {
    padding: 15px;
  }
  
  /* Toolbar Stacking */
  .toolbar {
    flex-direction: column;
    align-items: stretch;
    gap: 10px;
  }
  
  .search-box {
    width: 100%;
    max-width: none;
  }
  
  .search-input {
    font-size: 0.9rem;
    padding: 10px 15px 10px 40px;
  }
  
  /* Table Mobile Layout */
  .table-responsive {
    margin: 0 -15px;
    padding: 0 15px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  .equipment-table {
    min-width: 550px;
    font-size: 0.8rem;
  }
  
  .equipment-table th,
  .equipment-table td {
    padding: 6px 4px;
    font-size: 0.75rem;
  }
  
  .equipment-table th {
    font-size: 0.7rem;
    font-weight: 600;
  }
  
  /* Compact Package Display */
  .package-name {
    font-size: 0.8rem;
    line-height: 1.2;
  }
  
  .package-info-cell small {
    font-size: 0.65rem;
  }
  
  .progress-container {
    min-width: 70px;
  }
  
  .progress {
    height: 6px;
  }
  
  .category-badge {
    font-size: 0.65rem;
    padding: 2px 6px;
  }
  
  .status-badge {
    font-size: 0.6rem;
    min-width: 50px;
    padding: 2px 4px;
  }
  
  /* Stacked Action Buttons on Very Small Screens */
  .action-buttons {
    flex-direction: column;
    gap: 3px;
    align-items: center;
  }
  
  .action-buttons .btn {
    width: 28px;
    height: 28px;
    font-size: 0.7rem;
    padding: 4px;
  }
  
  /* Modal Improvements */
  .modal-dialog {
    margin: 5px;
    width: auto;
  }
  
  .modal-content {
    border-radius: 8px;
  }
  
  .modal-header {
    padding: 12px 15px;
    font-size: 1rem;
  }
  
  .modal-body {
    padding: 15px;
  }
}

/* Mobile - Small (480px and down) */
@media (max-width: 480px) {
  .equipment-table {
    min-width: 500px;
  }
  
  .equipment-table th,
  .equipment-table td {
    padding: 5px 3px;
    font-size: 0.7rem;
  }
  
  .equipment-table th i {
    display: none; /* Hide icons in headers on very small screens */
  }
  
  .package-name {
    font-size: 0.75rem;
  }
  
  .package-name i {
    font-size: 0.7rem;
  }
  
  .category-badge,
  .status-badge {
    font-size: 0.6rem;
  }
  
  .action-buttons .btn {
    width: 26px;
    height: 26px;
  }
  
  .action-buttons .btn i {
    font-size: 0.7rem;
  }
}

/* Mobile - Extra Small (400px and down) */
@media (max-width: 400px) {
  .card-header {
    padding: 10px 12px;
    font-size: 1rem;
  }
  
  .card-body {
    padding: 12px;
  }
  
  .equipment-table {
    min-width: 450px;
    font-size: 0.65rem;
  }
  
  .equipment-table th,
  .equipment-table td {
    padding: 4px 2px;
  }
  
  .action-buttons .btn {
    width: 24px;
    height: 24px;
    font-size: 0.6rem;
  }
  
  .progress-container {
    min-width: 60px;
  }
  
  .status-badge {
    min-width: 45px;
    font-size: 0.55rem;
  }
  
  /* Toast Messages */
  .toast-message {
    top: 10px;
    right: 10px;
    left: 10px;
    font-size: 0.8rem;
    padding: 10px 15px;
  }
}

/* ===== MOBILE CARD LAYOUT ===== */

/* Hide table on mobile and show card layout */
@media (max-width: 768px) {
  .table-responsive {
    display: none;
  }
  
  .mobile-cards-container {
    display: block;
  }
}

@media (min-width: 769px) {
  .mobile-cards-container {
    display: none;
  }
}

/* Mobile Card Styling */
.mobile-card {
  background: var(--card-bg);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  border: 1px solid var(--border-primary);
  position: relative;
  overflow: hidden;
}

.mobile-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: var(--primary-color);
}

.mobile-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
}

.mobile-card-number {
  background: var(--primary-color);
  color: white;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  font-weight: 600;
}

.mobile-card-status {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 4px;
}

.mobile-card-body {
  margin-bottom: 16px;
}

.mobile-card-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 0;
  border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.mobile-card-item:last-child {
  border-bottom: none;
}

.mobile-card-label {
  font-size: 0.8rem;
  color: var(--text-secondary);
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 6px;
}

.mobile-card-value {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-primary);
  text-align: right;
  flex: 1;
  margin-left: 8px;
}

.mobile-card-actions {
  display: flex;
  gap: 8px;
  justify-content: center;
  padding-top: 12px;
  border-top: 1px solid rgba(0, 0, 0, 0.05);
}

.mobile-card-btn {
  flex: 1;
  padding: 10px 12px;
  border-radius: 8px;
  border: none;
  font-size: 0.8rem;
  font-weight: 500;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  transition: all 0.3s ease;
  cursor: pointer;
}

.mobile-card-btn-primary {
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  color: white;
}

.mobile-card-btn-danger {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: white;
}

.mobile-card-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.mobile-card-btn:active {
  transform: translateY(0);
}

/* Mobile card details section */
.mobile-card-details {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin: 12px 0 8px 0;
}

.mobile-detail-item {
  display: flex;
  align-items: center;
  padding: 6px 8px;
  background: rgba(248, 250, 252, 0.8);
  border-radius: 6px;
  border-left: 3px solid #e2e8f0;
  transition: all 0.2s ease;
}

.mobile-detail-item i {
  font-size: 0.9rem;
  margin-right: 10px;
  min-width: 16px;
  text-align: center;
}

.mobile-detail-content {
  display: flex;
  flex-direction: column;
  flex: 1;
  min-width: 0;
}

.mobile-detail-label {
  font-size: 0.7rem;
  font-weight: 500;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  line-height: 1;
  margin-bottom: 2px;
}

.mobile-detail-value {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-primary);
  line-height: 1.2;
}

/* Package info in mobile cards */
.mobile-package-info {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.mobile-package-name {
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 8px;
}

.mobile-package-date {
  font-size: 0.75rem;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  gap: 4px;
}

/* Progress indicator for mobile cards */
.mobile-progress-section {
  margin: 8px 0;
  padding: 8px 12px;
  background: rgba(59, 130, 246, 0.05);
  border-radius: 8px;
  border-left: 3px solid var(--primary-color);
}

.mobile-progress-bar {
  height: 6px;
  background: rgba(59, 130, 246, 0.1);
  border-radius: 3px;
  overflow: hidden;
  margin-bottom: 6px;
}

.mobile-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #3b82f6, #1d4ed8);
  border-radius: 3px;
  transition: width 0.6s ease;
  position: relative;
}

.mobile-progress-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.3) 50%, transparent 70%);
  animation: progressShimmer 2s infinite;
}

.mobile-progress-text {
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--primary-color);
  text-align: center;
}

/* Empty state for mobile cards */
.mobile-empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--text-secondary);
}

.mobile-empty-state i {
  font-size: 3rem;
  color: var(--text-tertiary);
  margin-bottom: 16px;
  display: block;
}

.mobile-empty-state h3 {
  font-size: 1.1rem;
  margin-bottom: 8px;
  color: var(--text-primary);
}

.mobile-empty-state p {
  font-size: 0.9rem;
  line-height: 1.4;
}

/* ===== INVOICE MODAL MOBILE IMPROVEMENTS ===== */
@media (max-width: 768px) {
  #invoiceModal {
    top: 0;
    position: fixed;
  }
  
  #invoiceModal .modal-dialog {
    margin: 0;
    height: 100vh;
    max-height: 100vh;
    width: 100vw;
    max-width: 100vw;
  }
  
  #invoiceModal .modal-content {
    height: 100%;
    border-radius: 0;
    border: none;
  }
  
  #invoiceModal .modal-header {
    padding: 15px;
    background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
    color: white;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  #invoiceModal .modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 0;
  }
  
  #printArea {
    padding: 15px;
  }
  
  #printArea .container {
    padding: 0;
  }
  
  #printArea .logo {
    height: 40px !important;
  }
  
  #printArea .btn {
    padding: 8px 12px;
    font-size: 0.8rem;
    margin: 2px;
    width: calc(50% - 4px);
  }
  
  #printArea .table {
    font-size: 0.8rem;
  }
  
  #printArea .table th,
  #printArea .table td {
    padding: 6px 8px;
  }
  
  #printArea h5 {
    font-size: 1rem;
  }
  
  #printArea .alert {
    font-size: 0.8rem;
    padding: 10px;
  }
}

@media (max-width: 480px) {
  #printArea {
    padding: 10px;
  }
  
  #printArea .btn {
    width: 100%;
    margin-bottom: 5px;
  }
  
  #printArea .row {
    margin: 0;
  }
  
  #printArea .col-md-6 {
    padding: 0 5px;
  }
  
  #printArea .table {
    font-size: 0.75rem;
  }
  
  #printArea .table th,
  #printArea .table td {
    padding: 4px 6px;
  }
}

/* ===== MOBILE-FIRST IMPROVEMENTS ===== */

/* Touch-friendly interactions */
@media (max-width: 768px) {
  .action-buttons .btn,
  .receipt-btn,
  .btn-outline-danger,
  .btn-outline-success,
  .btn-outline-primary {
    min-height: 44px;
    min-width: 44px;
    touch-action: manipulation;
  }
  
  .equipment-table tr {
    cursor: default;
  }
  
  .package-info-cell {
    cursor: default;
  }
  
  .package-info-cell:active {
    background-color: rgba(79, 70, 229, 0.1);
    transform: scale(0.98);
  }
}

/* Improved focus states for mobile */
@media (max-width: 768px) {
  .action-buttons .btn:focus,
  .receipt-btn:focus {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
    box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2);
  }
}

/* Loading states mobile optimization */
@media (max-width: 768px) {
  .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  
  .fa-spinner {
    font-size: 0.9rem;
  }
}

/* Enhanced mobile typography */
@media (max-width: 576px) {
  .card-header {
    line-height: 1.3;
  }
  
  .equipment-table th {
    line-height: 1.2;
  }
  
  .package-name {
    line-height: 1.3;
  }
  
  .category-badge,
  .status-badge {
    line-height: 1.2;
  }
}

/* Mobile-specific animations */
@media (max-width: 768px) {
  .equipment-table tbody tr {
    transition: background-color 0.2s ease;
  }
  
  .equipment-table tbody tr:active {
    background-color: rgba(79, 70, 229, 0.05);
  }
  
  .action-buttons .btn {
    transition: transform 0.15s ease, background-color 0.15s ease;
  }
  
  .action-buttons .btn:active {
    transform: scale(0.95);
  }
}

/* Accessibility improvements for mobile */
@media (max-width: 768px) {
  .sr-only {
    position: absolute !important;
    width: 1px !important;
    height: 1px !important;
    padding: 0 !important;
    margin: -1px !important;
    overflow: hidden !important;
    clip: rect(0, 0, 0, 0) !important;
    white-space: nowrap !important;
    border: 0 !important;
  }
}

  </style>
</head>
<body style="background-color: #F3F3F9;">
  <div class="container-scroller">
    <!-- Navbar Partial -->
    <%- include ('../partials/_navbar.ejs') %>
    <div class="container-fluid page-body-wrapper" style="padding-left: 0 !important; padding-right: 0 !important;">
      <!-- Sidebar Start -->
      <%- include ('../partials/Sidebar.ejs') %>
      <!-- Sidebar End -->
      <div class="main-panel" style="width: 100%;">
        <div class="content-wrapper">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <i class="bi bi-clock-history"></i> History
              <div class="header-actions d-flex align-items-center gap-3">
                <input type="date" id="filterFromDate" class="form-control form-control-sm" placeholder="From Date" />
                <input type="date" id="filterToDate" class="form-control form-control-sm" placeholder="To Date" />
                <button id="filterBtn" class="btn btn-primary btn-sm">Filter</button>
                <button id="clearFilterBtn" class="btn btn-secondary btn-sm">Clear</button>
              </div>
            </div>
            <div class="card-body">
              <div class="toolbar"></div>
              <div class="table-responsive d-none d-lg-block">
                <table class="equipment-table" id="historyTable">
                  <thead>
                    <tr>
                      <th class="name-col">
                        <i class="fas fa-hashtag me-2"></i>#
                      </th>
                      <th class="name-col">
                        <i class="fas fa-box me-2"></i>Package Details
                      </th>
                      <th class="type-col">
                        <i class="fas fa-percentage me-2"></i>Payment Progress
                      </th>
                      <th class="category-col">
                        <i class="fas fa-file-invoice me-2"></i>Status
                      </th>
                      <th class="quantity-col">
                        <i class="fas fa-tools me-2"></i>Actions
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <% if (packages && packages.length > 0) { %>
                      <% console.log('History Debug - Packages length:', packages.length); %>
                      <% packages.forEach((package, index) => { 
                        let result = 0;
                        if (package.amount && package.amount > 0 && package.custom_amount) {
                          if (package.custom_amount >= package.amount) {
                            result = 100;
                          } else {
                            result = (package.custom_amount * 100) / package.amount;
                          }
                        } else if (package.amount === 0 || !package.amount) {
                          // If amount is 0 or null, result should be 0 (Due status)
                          result = 0;
                        }
                        // Show all packages (including 0% payment) to display complete history
                        if (true) { %>
                    <tr data-accepted="<%= package.Accepted %>">
                      <td class="name-col">
                        <%= index + 1 %>
                        <input type="hidden" name="id" value="<%= package.id || package.transaction_id %>">
                      </td>
                      <td class="name-col">
                        <div class="package-info-cell" 
                          onclick="document.getElementById('receipt-<%= package.transaction_id %>').click(); return false;"
                          style="cursor: pointer;">
                          <div class="package-name">
                            <i class="fas fa-wifi me-2 text-primary"></i>
                            <strong><%= package.package_name %> MB</strong>
                          </div>
                          <small class="text-muted">
                            <i class="far fa-calendar me-1"></i>
                            <%= new Date(package.created_at || package.Accepted).toLocaleDateString() %>
                          </small>
                        </div>
                      </td>
                      <td class="type-col">
                        <div class="progress-container">
                          <div class="progress mb-1" style="height: 8px;">
                            <div class="progress-bar bg-primary" style="width: <%= Math.min(result, 100) %>%"></div>
                          </div>
                          <span class="category-badge">
                            <i class="fas fa-chart-pie me-1"></i>
                            <strong><%= result.toFixed(2) %>%</strong>
                          </span>
                        </div>
                      </td>
                      <td class="category-col">
                        <% if (result >= 100) { %>
                          <span class="badge status-badge paid" style="background-color: #dcf1e2; color: #20754d; padding: 4px 8px; border-radius: 4px;">
                            <i class="fas fa-check-circle me-1"></i>Paid
                          </span>
                        <% } else if (result > 0) { %>
                          <span class="badge status-badge partial" style="background-color: #fff3cd; color: #856404; padding: 4px 8px; border-radius: 4px;">
                            <i class="fas fa-clock me-1"></i>Partial
                          </span>
                        <% } else { %>
                          <span class="badge status-badge due" style="background-color: #f8d7da; color: #721c24; padding: 4px 8px; border-radius: 4px;">
                            <i class="fas fa-exclamation-circle me-1"></i>Due
                          </span>
                        <% } %>
                      </td>
                      <td class="quantity-col">
                        <div class="action-buttons">
                          <button class="btn btn-sm receipt-btn btn-outline-primary d-flex align-items-center justify-content-center me-2"
                            data-transaction-id="<%= package.transaction_id %>"
                            data-package-name="<%= package.package_name %>"
                            data-accepted="<%= package.Accepted %>"
                            data-amount="<%= package.amount %>"
                            data-coins="<%= package.coins %>"
                            data-discount="<%= package.discount %>"
                            data-remaining="<%= package.remaining_amount %>"
                            data-custom-amount="<%= package.custom_amount %>"
                            style="width: 40px; height: 40px; border-radius: 50%;"
                            title="View Invoice">
                           <i class="fas fa-file-invoice"></i>
                          </button>
                          <button class="btn btn-sm email-invoice-btn btn-outline-info d-flex align-items-center justify-content-center me-2 no-print"
                            data-invoice-id="<%= package.transaction_id %>"
                            style="width: 40px; height: 40px; border-radius: 50%;"
                            title="Email Invoice"
                            onclick="emailInvoiceFromHistorySimple(this)"
                            ondblclick="emailInvoiceFromHistoryFallback(this)">
                           <i class="fas fa-envelope"></i>
                          </button>
                          <button type="button" class="btn btn-sm btn-outline-danger d-flex align-items-center justify-content-center"
                            style="width: 40px; height: 40px; border-radius: 50%;"
                            onclick="deletePackage('<%= package.id %>', this)"
                            title="Delete Package">
                            <i class="fas fa-trash-alt"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                    <% } }) %>

                    <% } else { %>
                      <tr>
                        <td colspan="5" class="text-center py-4">
                          <div class="text-muted">
                            <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                            <h5>No Payment History Found</h5>
                            <p>You haven't made any payments yet. Start by purchasing a package!</p>
                          </div>
                        </td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>

              <!-- Mobile Cards Container (Hidden on desktop) -->
              <div class="mobile-cards-container d-block d-lg-none">
                <% if (packages && packages.length > 0) { %>
                  <% packages.forEach((package) => { 
                    const result = (() => {
                      if (package.amount && package.amount > 0 && package.custom_amount) {
                        if (package.custom_amount >= package.amount) {
                          return 100;
                        } else {
                          return (package.custom_amount * 100) / package.amount;
                        }
                      } else if (package.amount === 0 || !package.amount) {
                        return 0;
                      } else if (package.custom_amount) {
                        return (package.custom_amount * 100) / (package.amount || 1);
                      }
                      return 0;
                    })();
                  %>
                    <div class="mobile-card" data-accepted="<%= package.Accepted %>">
                      <div class="mobile-card-header">
                        <div class="mobile-package-info">
                          <div class="mobile-package-name">
                            <i class="fas fa-wifi text-primary"></i>
                            <strong><%= package.package_name %> MB</strong>
                            <% if (result >= 100) { %>
                              <span class="badge bg-success ms-auto">Paid</span>
                            <% } else if (result > 0) { %>
                              <span class="badge bg-warning ms-auto">Partial</span>
                            <% } else { %>
                              <span class="badge bg-danger ms-auto">Due</span>
                            <% } %>
                          </div>
                          <div class="mobile-package-date">
                            <i class="far fa-calendar"></i>
                            <%= new Date(package.created_at || package.Accepted).toLocaleDateString() %>
                          </div>
                        </div>
                      </div>

                      <div class="mobile-card-body">
                        <div class="mobile-progress-section">
                          <div class="mobile-progress-bar">
                            <div class="mobile-progress-fill" style="width: <%= Math.min(result, 100) %>%"></div>
                          </div>
                          <div class="mobile-progress-text">
                            <i class="fas fa-chart-pie me-1"></i>
                            <strong><%= result.toFixed(2) %>% Paid</strong>
                          </div>
                        </div>

                        <div class="mobile-card-details">
                          <div class="mobile-detail-item">
                            <i class="fas fa-dollar-sign text-success"></i>
                            <div class="mobile-detail-content">
                              <span class="mobile-detail-label">Amount</span>
                              <span class="mobile-detail-value">$<%= package.amount || 0 %></span>
                            </div>
                          </div>
                          <% if (package.custom_amount > 0) { %>
                          <div class="mobile-detail-item">
                            <i class="fas fa-credit-card text-info"></i>
                            <div class="mobile-detail-content">
                              <span class="mobile-detail-label">Paid</span>
                              <span class="mobile-detail-value">$<%= package.custom_amount %></span>
                            </div>
                          </div>
                          <% } %>
                          <% if (package.remaining_amount > 0) { %>
                          <div class="mobile-detail-item">
                            <i class="fas fa-clock text-warning"></i>
                            <div class="mobile-detail-content">
                              <span class="mobile-detail-label">Remaining</span>
                              <span class="mobile-detail-value">$<%= package.remaining_amount %></span>
                            </div>
                          </div>
                          <% } %>
                        </div>
                      </div>

                      <div class="mobile-card-actions">
                        <button class="mobile-card-btn receipt-btn"
                          data-transaction-id="<%= package.transaction_id %>"
                          data-package-name="<%= package.package_name %>"
                          data-accepted="<%= package.Accepted %>"
                          data-amount="<%= package.amount %>"
                          data-coins="<%= package.coins %>"
                          data-discount="<%= package.discount %>"
                          data-remaining="<%= package.remaining_amount %>"
                          data-custom-amount="<%= package.custom_amount %>">
                          <i class="fas fa-file-invoice"></i>
                          View Invoice
                        </button>
                        <button class="mobile-card-btn email-invoice-btn btn-outline-info no-print"
                          data-invoice-id="<%= package.transaction_id %>"
                          onclick="emailInvoiceFromHistorySimple(this)"
                          ondblclick="emailInvoiceFromHistoryFallback(this)"
                          title="Email Invoice (Double-click for advanced retry)"
                          style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); margin-top: 8px;">
                          <i class="fas fa-envelope"></i>
                          Email Invoice
                        </button>
                        <button class="mobile-card-btn mobile-card-btn-danger"
                          onclick="deletePackageCard('<%= package.id %>', this)"
                          title="Delete Package">
                          <i class="fas fa-trash-alt"></i>
                          Delete
                        </button>
                      </div>
                    </div>
                  <% }) %>
                <% } else { %>
                  <div class="mobile-empty-state">
                    <i class="fas fa-inbox"></i>
                    <h3>No Payment History Found</h3>
                    <p>You haven't made any payments yet.<br>Start by purchasing a package!</p>
                  </div>
                <% } %>
              </div>

              <script>
                function deletePackage(id, btn) {
                  // Enhanced confirmation dialog with better styling
                  const confirmed = showDeleteConfirmation();
                  if (!confirmed) return;
                  
                  // Show loading state
                  const originalContent = btn.innerHTML;
                  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                  btn.disabled = true;
                  
                  fetch('/delete-package', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({ 
                      id: id,
                      type: 'payments' // Specify the type as payments for history
                    })
                  })
                  .then(response => {
                    if (response.ok) {
                      // Animate row removal
                      const row = btn.closest('tr');
                      if (row) {
                        row.style.transition = 'all 0.3s ease';
                        row.style.transform = 'translateX(-100%)';
                        row.style.opacity = '0';
                        setTimeout(() => {
                          row.remove();
                          showSuccessMessage('Package deleted successfully!');
                          updateEntryCount();
                        }, 300);
                      }
                    } else {
                      throw new Error('Delete request failed');
                    }
                  })
                  .catch(error => {
                    console.error('Error deleting package:', error);
                    showErrorMessage('Failed to delete package. Please try again.');
                    // Restore button state
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                  });
                }
                
                function showDeleteConfirmation() {
                  return confirm('⚠️ Are you sure you want to delete this package?\n\nThis action cannot be undone and will permanently remove the package from your history.');
                }
                
                function showSuccessMessage(message) {
                  const toast = document.createElement('div');
                  toast.className = 'toast-message success';
                  toast.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
                  document.body.appendChild(toast);
                  setTimeout(() => toast.remove(), 3000);
                }
                
                function showErrorMessage(message) {
                  const toast = document.createElement('div');
                  toast.className = 'toast-message error';
                  toast.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
                  document.body.appendChild(toast);
                  setTimeout(() => toast.remove(), 4000);
                }
                
                function updateEntryCount() {
                  const visibleRows = document.querySelectorAll('#historyTable tbody tr:not([style*="display: none"]):not(.no-data)');
                  const countElement = document.querySelector('.showing-entries span');
                  if (countElement) {
                    countElement.textContent = visibleRows.length;
                  }
                }

                // Mobile card delete functionality
                function deletePackageCard(id, btn) {
                  // Enhanced confirmation dialog with better styling
                  const confirmed = showDeleteConfirmation();
                  if (!confirmed) return;
                  
                  // Show loading state
                  const originalContent = btn.innerHTML;
                  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                  btn.disabled = true;
                  
                  fetch('/delete-package', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({ 
                      id: id,
                      type: 'payments'
                    })
                  })
                  .then(response => {
                    if (response.ok) {
                      // Animate card removal
                      const card = btn.closest('.mobile-card');
                      card.style.transition = 'all 0.3s ease';
                      card.style.opacity = '0';
                      card.style.transform = 'translateX(-100%)';
                      setTimeout(() => {
                        card.remove();
                        showSuccessToast('Package deleted successfully!');
                        
                        // Check if no cards remain
                        const remainingCards = document.querySelectorAll('.mobile-card');
                        if (remainingCards.length === 0) {
                          document.querySelector('.mobile-cards-container').innerHTML = `
                            <div class="mobile-empty-state">
                              <i class="fas fa-inbox"></i>
                              <h3>No Payment History Found</h3>
                              <p>You haven't made any payments yet.<br>Start by purchasing a package!</p>
                            </div>
                          `;
                        }
                      }, 300);
                    } else {
                      throw new Error('Failed to delete');
                    }
                  })
                  .catch(error => {
                    console.error('Error deleting package:', error);
                    showErrorToast('Failed to delete package. Please try again.');
                    
                    // Restore button
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                  });
                }
              </script>

              <!-- Subscribed Packages Table -->
              <% /* Removed subscribed packages separate table and filter as per user request */ %>
              <% /* Merging subscribedPackages into packages table below */ %>
              <% subscribedPackages.forEach(subPackage => { %>
                <% if ((subPackage.custom_amount * 100) / subPackage.amount === 100) { %>
                  <% packages.push(subPackage); %>
                <% } %>
              <% }); %>
              <!-- The packages table already displays all packages including subscribed ones with 100% paid -->
            </div>
            
            
           <script>
  // ================== HISTORY FILTER ==================
  document.getElementById('filterBtn').addEventListener('click', function () {
    const fromDateStr = document.getElementById('filterFromDate').value;
    const toDateStr = document.getElementById('filterToDate').value;

    const fromDate = fromDateStr ? new Date(fromDateStr) : null;
    const toDate = toDateStr ? new Date(toDateStr) : null;

    const rows = document.querySelectorAll('#historyTable tbody tr');
    const cards = document.querySelectorAll('.mobile-card');

    // Filter table rows
    rows.forEach(row => {
      const acceptedDateStr = row.getAttribute('data-accepted');
      const acceptedDate = new Date(acceptedDateStr);

      let show = true;

      if (fromDate && acceptedDate < fromDate) show = false;
      if (toDate && acceptedDate > toDate) show = false;

      row.style.display = show ? '' : 'none';
    });

    // Filter mobile cards
    cards.forEach(card => {
      const acceptedDateStr = card.getAttribute('data-accepted');
      const acceptedDate = new Date(acceptedDateStr);

      let show = true;

      if (fromDate && acceptedDate < fromDate) show = false;
      if (toDate && acceptedDate > toDate) show = false;

      card.style.display = show ? '' : 'none';
    });
  });

  document.getElementById('clearFilterBtn').addEventListener('click', function () {
    document.getElementById('filterFromDate').value = '';
    document.getElementById('filterToDate').value = '';
    const rows = document.querySelectorAll('#historyTable tbody tr');
    const cards = document.querySelectorAll('.mobile-card');
    rows.forEach(row => row.style.display = '');
    cards.forEach(card => card.style.display = '');
  });

  // ================== SUBSCRIBED PACKAGES FILTER ==================
  document.getElementById('subscribedFilterBtn')?.addEventListener('click', function () {
    const fromDateStr = document.getElementById('subscribedFromDate').value;
    const toDateStr = document.getElementById('subscribedToDate').value;

    const fromDate = fromDateStr ? new Date(fromDateStr) : null;
    const toDate = toDateStr ? new Date(toDateStr) : null;

    const rows = document.querySelectorAll('#subscribedPackagesTable tbody tr');

    rows.forEach(row => {
      const createdDateStr = row.getAttribute('data-created');
      const expiryDateStr = row.getAttribute('data-expiry');

      const createdDate = new Date(createdDateStr);
      const expiryDate = new Date(expiryDateStr);

      let show = true;

      // Check if package start & expiry dates are within filter range
      if (fromDate && expiryDate < fromDate) show = false;
      if (toDate && createdDate > toDate) show = false;

      row.style.display = show ? '' : 'none';
    });
  });

  document.getElementById('subscribedClearFilterBtn')?.addEventListener('click', function () {
    document.getElementById('subscribedFromDate').value = '';
    document.getElementById('subscribedToDate').value = '';
    const rows = document.querySelectorAll('#subscribedPackagesTable tbody tr');
    rows.forEach(row => row.style.display = '');
  });
</script>

          </div>
        </div>
      </div>
    </div>

    <!-- Invoice Modal -->
    <div class="modal fade " style="top: -90px; position: absolute; margin-bottom: 30px; height: 100%;" id="invoiceModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered custom-modal-height">
 
        <div class="modal-content border-0 shadow">
          <div class="modal-header bg-gradient-primary text-white">
            <h5 class="modal-title fw-bold"><i class="fas fa-file-invoice me-2"></i> INVOICE</h5>
      <button type="button" class="btn-close text-danger " data-bs-dismiss="modal" aria-label="Close" style="  padding: 4px;  filter: invert(29%) sepia(91%) saturate(7484%) hue-rotate(356deg) brightness(89%) contrast(110%);"></button>











          </div>
          <div class="modal-body  p-0">
            <div id="printArea">
              <div class="container my-1 position-relative" style="background-color: #f8f9fa;">
                <!-- Top Logo and Buttons -->
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 rounded"
                  style="background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);">
                  <img src="/images/ClickTake.png" alt="Falcon Logo" class="logo"
                    style="height: 50px; filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.2));">
                  <div >
                    <button style="overflow: hidden;" class="btn btn-success me-2 shadow-sm no-print" onclick="downloadInvoice()">
                      <i class="fas fa-download me-1"></i> Download Invoice
                    </button>
</div>
                </div>
                <hr class="border-2 border-top" style="border-color: #4e73df!important; opacity: 0.7;">
                <!-- Invoice Info -->
                <div class="row mb-2 p-2 rounded" style="background-color: #fff; border-left: 4px solid #4e73df;">
                  <div class="col-md-6">
                    <h5 class="text-uppercase text-info mb-3"><i class="fas fa-user-circle me-2"></i> INVOICE TO:</h5>
                    <p class="mb-1"><strong>Click Optics</strong> (<span id="i-username" class="text-primary">Username</span>)</p>
                    <p class="mb-1 text-muted"><i class="fas fa-map-marker-alt me-2"></i> <span id="i-address">Rid</span></p>
                  </div>
                  <div class="col-md-6 text-md-end">
                    <h5 class="mb-2"><span class="badge bg-primary p-2">INVOICE # P<span id="i-invoice-no">51717</span></span></h5>
                    <p class="mb-1"><i class="far fa-calendar-alt me-2 text-info"></i> <strong>Date:</strong> <span id="i-date" class="text-dark">may 00, 0000</span></p>
                    <p class="mb-1"><i class="fas fa-wallet me-2 text-info"></i> <strong>Payment Method:</strong> <span class="badge bg-danger" id="i-payment-method">Due</span></p>
                    <p class="mb-0"><i class="fas fa-file-invoice me-2 text-info"></i> <strong>Invoice Type:</strong> <span class="badge bg-secondary">Regular Invoice</span></p>
                  </div>
                </div>
                <!-- Invoice Table -->
                <div class="table-responsive">
                  <table class="table table-bordered table-hover">
                    <thead class="bg-light-primary text-dark">
                      <tr>
                        <th class="text-center">#</th>
                        <th>Package Name</th>
                        <th>Next Expiry</th>
                        <th class="text-end">Price</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td class="text-center">01</td>
                        <td id="i-package-name" class="fw-bold">P-10-MB</td>
                        <td id="i-expiry-date" class="text-success fw-bold">00, May 0000 00:00 PM</td>
                        <td id="i-amount" class="text-end fw-bold">00.00</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <!-- Totals -->
                <div class="d-flex justify-content-end mt-2">
                  <table class="table table-bordered w-auto shadow-sm">
                    <tr class="bg-light-warning">
                      <td class="fw-bold">DISCOUNT:</td>
                      <td class="text-end fw-bold text-success" id="i-discount">0.00</td>
                    </tr>
                    <tr class="bg-light-info">
                      <td class="fw-bold">COINS USED:</td>
                      <td class="text-end fw-bold text-info" id="i-coins">0.00</td>
                    </tr>
                    <tr class="bg-light-success">
                      <td class="fw-bold">Paid Amount:</td>
                      <td class="text-end fw-bold text-success" id="i-paid-amount">0.00</td>
                    </tr>
                    <tr class="bg-light-danger">
                      <td class="fw-bold">Remaining Amount:</td>
                      <td class="text-end fw-bold text-danger" id="i-remaining-amount">0.00</td>
                    </tr>
                    <tr class="bg-primary text-white">
                      <th class="fw-bold fs-5">GRAND TOTAL:</th>
                      <th class="text-end fs-5" id="i-grand-total">00.00</th>
                    </tr>
                  </table>
                </div>
                <!-- Thank You and Notice -->
                <div class="mt-2 p-2 rounded" style="background-color: #f8f9fa; border-top: 3px solid #4e73df;">
                  <p class="fw-bold text-center text-primary mb-4" style="font-size: 1.2rem;">
                    <i class="fas fa-heart text-danger me-2"></i> Thank you for your business!
                  </p>
                  <div class="alert alert-warning text-center">
                    <strong><i class="fas fa-exclamation-circle me-2"></i>NOTICE:</strong> Please pay your unpaid bill
                    within next 7 days for uninterrupted internet services.<br>
                    Invoice was created on a computer and is valid without the signature and seal.
                  </div>
                  <div class="text-center text-muted small mt-3">
                    <i class="fas fa-lock me-1"></i> Secure Payment Invoice | <i class="fas fa-shield-alt me-1"></i>
                    Protected Content
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- JS for Receipt and Date Filtering -->
    <script>
      // Verify html2pdf.js is loaded
      if (typeof html2pdf === 'undefined') {
        console.error('html2pdf.js is not loaded');
      } else {
        console.log('html2pdf.js is loaded');
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Format Sent Dates
        document.querySelectorAll(".i-date").forEach(span => {
          const rawDate = span.dataset.date;
          const date = new Date(rawDate);
          const formatted = date.toLocaleString('en-US', {
            timeZone: 'Asia/Karachi',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
          });
          span.textContent = formatted;
        });

        // Receipt Modal Logic
        document.querySelectorAll(".receipt-btn").forEach(button => {
          button.addEventListener("click", function () {
            const transactionId = this.dataset.transactionId;
            const packageName = this.dataset.packageName;
            const amount = parseFloat(this.dataset.amount);
            const discount = parseFloat(this.dataset.discount) || 0;
            const coins = parseFloat(this.dataset.coins) || 0;
            const paidAmount = parseFloat(this.dataset.customAmount) || 0;
            const remainingAmount = parseFloat(this.dataset.remaining) || 0;

            const invoiceDate = new Date().toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'numeric',
              day: 'numeric'
            });

            const expiryDate = new Date();
            expiryDate.setDate(expiryDate.getDate() + 30);
            const formattedExpiry = expiryDate.toLocaleDateString('en-US', {
              day: 'numeric',
              month: 'short',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });

           document.getElementById("i-invoice-no").textContent = this.closest("tr").querySelector("input[name='id']")?.value || "0";

            document.getElementById("i-date").textContent = invoiceDate;
            document.getElementById("i-package-name").textContent = packageName;
            document.getElementById("i-expiry-date").textContent = formattedExpiry;
            document.getElementById("i-amount").textContent = amount.toFixed(2);
            document.getElementById("i-discount").textContent = `${discount.toFixed(2)}%`;
            document.getElementById("i-coins").textContent = coins.toFixed(2);
            document.getElementById("i-paid-amount").textContent = paidAmount.toFixed(2);
            document.getElementById("i-grand-total").textContent = (paidAmount + remainingAmount).toFixed(2);
            document.getElementById("i-remaining-amount").textContent = remainingAmount.toFixed(2);

            const invoiceModal = new bootstrap.Modal(document.getElementById('invoiceModal'));
            invoiceModal.show();
          });
        });

        // Filter by From/To Date
      document.getElementById("filterBtn")?.addEventListener("click", function () {
          const fromDateStr = document.getElementById("filterFromDate").value;
          const toDateStr = document.getElementById("filterToDate").value;
          const rows = document.querySelectorAll('#historyTable tbody tr');

          if (!fromDateStr || !toDateStr) {
            alert("Please select both From Date and To Date to filter.");
            return;
          }

          if (moment(fromDateStr, 'YYYY-MM-DD').isAfter(moment(toDateStr, 'YYYY-MM-DD'))) {
            alert("From Date cannot be later than To Date.");
            return;
          }

          rows.forEach(row => {
            const acceptedDateStr = row.getAttribute('data-accepted');
            if (!acceptedDateStr) {
              row.style.display = 'none';
              return;
            }
            const acceptedDate = moment(acceptedDateStr, 'YYYY-MM-DD');
            const fromDate = moment(fromDateStr, 'YYYY-MM-DD');
            const toDate = moment(toDateStr, 'YYYY-MM-DD');

            if (acceptedDate.isSameOrAfter(fromDate) && acceptedDate.isSameOrBefore(toDate)) {
              row.style.display = '';
            } else {
              row.style.display = 'none';
            }
          });
        });
      });

      function downloadInvoice() {
        const element = document.getElementById("printArea");
        const downloadButton = document.querySelector('.btn-success.me-2');

        if (!element) {
          console.error('printArea element not found');
          alert('Error: Could not find invoice content to generate PDF.');
          return;
        }

        if (downloadButton) {
          downloadButton.style.display = 'none';
        }
        

        const opt = {
          margin: 0.5,
          filename: `invoice_${document.getElementById("i-invoice-no").textContent}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2, useCORS: true },
          jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
        };

        html2pdf()
          .set(opt)
          .from(element)
          .save()
          .then(() => {
            if (downloadButton) {
              downloadButton.style.display = '';
            }
          })
          .catch(error => {
            console.error('PDF generation failed:', error);
            alert('Failed to generate PDF. Please try again or contact support.');
            if (downloadButton) {
              downloadButton.style.display = '';
            }
          });
      }
      
function emailInvoice() {
  const invoiceId = document.getElementById("i-invoice-no").textContent;

  fetch(`/email-invoice/${invoiceId}`)
    .then(res => res.text())
    .then(msg => {
      alert(msg);
    })
    .catch(err => {
      console.error("Failed to send invoice email:", err);
      alert("Failed to send invoice email.");
    });
}

// Enhanced function for emailing invoice from history buttons
function emailInvoiceFromHistory(button) {
  let invoiceId = button.getAttribute('data-invoice-id');
  const originalContent = button.innerHTML;
  
  // Try to get the ID from the closest row's hidden input if data-invoice-id is not available
  if (!invoiceId) {
    const row = button.closest('tr');
    const hiddenInput = row ? row.querySelector('input[name="id"]') : null;
    invoiceId = hiddenInput ? hiddenInput.value : null;
  }
  
  // Validate invoice ID
  if (!invoiceId || invoiceId === 'null' || invoiceId === 'undefined') {
    showErrorMessage('Invalid invoice ID. Please try again.');
    console.error('Invoice ID missing:', invoiceId);
    return;
  }
  
  console.log('Attempting to email invoice with ID:', invoiceId);
  
  // Show loading state
  if (button.classList.contains('mobile-card-btn')) {
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
  } else {
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
  }
  button.disabled = true;
  
  // Enhanced fetch with better error handling
  fetch(`/email-invoice/${invoiceId}`, {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json, text/plain, */*'
    }
  })
  .then(response => {
    console.log('Email response status:', response.status);
    console.log('Email response statusText:', response.statusText);
    console.log('Email response URL:', response.url);
    
    // First, try to get the response text to see what the server is returning
    return response.text().then(text => {
      console.log('Email response text:', text);
      
      if (response.status === 200 || response.status === 201) {
        return text;
      } else if (response.status === 404) {
        throw new Error('Invoice not found. Server response: ' + text);
      } else if (response.status === 500) {
        throw new Error('Server error. Server response: ' + text);
      } else {
        throw new Error(`HTTP ${response.status}: ${response.statusText}. Response: ${text}`);
      }
    });
  })
  .then(msg => {
    console.log('Success response:', msg);
    showSuccessMessage('Invoice email sent successfully!');
    
    if (button.classList.contains('mobile-card-btn')) {
      button.innerHTML = '<i class="fas fa-check"></i> Email Sent!';
    } else {
      button.innerHTML = '<i class="fas fa-check"></i>';
    }
    
    setTimeout(() => {
      button.innerHTML = originalContent;
      button.disabled = false;
    }, 3000);
  })
  .catch(err => {
    console.error("Email invoice error details:", err);
    
    let errorMessage = 'Failed to send invoice email.';
    if (err.message.includes('Invoice not found')) {
      errorMessage = 'Invoice not found. Please refresh and try again.';
    } else if (err.message.includes('Server error')) {
      errorMessage = 'Server error. Please try again in a moment.';
    } else if (err.message.includes('Failed to fetch')) {
      errorMessage = 'Network error. Please check your connection.';
    }
    
    showErrorMessage(errorMessage);
    button.innerHTML = originalContent;
    button.disabled = false;
  });
}

// Alternative email function using different approaches
function emailInvoiceFromHistoryFallback(button) {
  const invoiceId = button.getAttribute('data-invoice-id');
  const originalContent = button.innerHTML;
  
  // Try multiple potential endpoints
  const endpoints = [
    `/email-invoice/${invoiceId}`,
    `/send-invoice-email/${invoiceId}`, 
    `/invoice/email/${invoiceId}`,
    `/api/email-invoice/${invoiceId}`
  ];
  
  let currentEndpoint = 0;
  
  function tryNextEndpoint() {
    if (currentEndpoint >= endpoints.length) {
      showErrorMessage('All email endpoints failed. Please contact support.');
      button.innerHTML = originalContent;
      button.disabled = false;
      return;
    }
    
    const endpoint = endpoints[currentEndpoint];
    console.log(`Trying endpoint ${currentEndpoint + 1}/${endpoints.length}:`, endpoint);
    
    fetch(endpoint)
      .then(response => {
        if (response.ok) {
          return response.text();
        } else {
          throw new Error(`HTTP ${response.status} for ${endpoint}`);
        }
      })
      .then(msg => {
        console.log(`Success with endpoint:`, endpoint);
        showSuccessMessage('Invoice email sent successfully!');
        button.innerHTML = '<i class="fas fa-check"></i>';
        setTimeout(() => {
          button.innerHTML = originalContent;
          button.disabled = false;
        }, 3000);
      })
      .catch(err => {
        console.log(`Failed endpoint ${endpoint}:`, err.message);
        currentEndpoint++;
        tryNextEndpoint();
      });
  }
  
  button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
  button.disabled = true;
  tryNextEndpoint();
}

// Simple email function that uses the same logic as the modal
function emailInvoiceFromHistorySimple(button) {
  // Get the invoice ID from the modal approach 
  const row = button.closest('tr');
  const hiddenInput = row ? row.querySelector('input[name="id"]') : null;
  let invoiceId = hiddenInput ? hiddenInput.value : null;
  
  // Fallback to data attribute
  if (!invoiceId) {
    invoiceId = button.getAttribute('data-invoice-id');
  }
  
  if (!invoiceId) {
    showErrorMessage('Cannot find invoice ID');
    return;
  }
  
  const originalContent = button.innerHTML;
  button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
  button.disabled = true;
  
  // Use the exact same approach as the working modal function
  fetch(`/email-invoice/${invoiceId}`)
    .then(res => res.text())
    .then(msg => {
      console.log('Email response:', msg);
      // Check if the response indicates success
      if (msg.toLowerCase().includes('success') || msg.toLowerCase().includes('sent')) {
        showSuccessMessage('Invoice email sent successfully!');
        button.innerHTML = '<i class="fas fa-check"></i>';
      } else {
        showSuccessMessage(msg); // Show whatever the server returned
        button.innerHTML = '<i class="fas fa-check"></i>';
      }
      setTimeout(() => {
        button.innerHTML = originalContent;
        button.disabled = false;
      }, 3000);
    })
    .catch(err => {
      console.error("Failed to send invoice email:", err);
      showErrorMessage('Failed to send invoice email: ' + err.message);
      button.innerHTML = originalContent;
      button.disabled = false;
    });
}


    </script>

    <!-- Plugins:js -->
    <script src="vendors/js/vendor.bundle.base.js"></script>
    <!-- Plugin js for this page -->
    <script src="vendors/chart.js/Chart.min.js"></script>
    <script src="vendors/datatables.net/jquery.dataTables.js"></script>
    <script src="vendors/datatables.net-bs4/dataTables.bootstrap4.js"></script>
    <script src="js/dataTables.select.min.js"></script>
    <!-- Inject:js -->
    <script src="js/off-canvas.js"></script>
    <script src="js/hoverable-collapse.js"></script>
    <script src="js/template.js"></script>
    <script src="js/settings.js"></script>
    <!-- Custom js for this page -->
    <script src="js/dashboard.js"></script>
    <script src="js/Chart.roundedBarCharts.js"></script>
    <!-- Bootstrap 5 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- html2pdf Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <%- include('../partials/_footer.ejs') %>
</body>
</html>