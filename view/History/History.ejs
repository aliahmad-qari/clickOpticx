<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>History</title>
    <link rel="stylesheet" href="vendors/feather/feather.css">
    <link rel="stylesheet" href="vendors/ti-icons/css/themify-icons.css">
    <link rel="stylesheet" href="vendors/css/vendor.bundle.base.css">
    <!-- Plugin css for this page -->
    <link rel="stylesheet" href="vendors/datatables.net-bs4/dataTables.bootstrap4.css">
    <link rel="stylesheet" type="text/css" href="js/select.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <link rel="stylesheet" href="css/vertical-layout-light/style.css">
    <!-- endinject -->
    <link rel="shortcut icon" href="images/favicon.png" />
    <!-- Material Design Icons CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

  <style>
    :root {
      --primary: #6c5ce7;
      --primary-light: #a29bfe;
      --secondary: #00cec9;
      --success: #198754;
      --success-light: #198754;
      --warning: #fdcb6e;
      --danger: #d63031;
      --dark: #2d3436;
      --light: #f5f6fa;
      --gray: #dfe6e9;
      --card-bg: rgba(255, 255, 255, 0.9);
      --glass-effect: rgba(255, 255, 255, 0.15);
    }

    body {
      background: #f5f6fa;
      color: var(--dark);
    }
    @media (max-width: 767px) {
  .equipment-table {
    min-width: unset !important;
    width: 100% !important;
    table-layout: auto !important;
  }

  .equipment-table th,
  .equipment-table td {
    padding: 8px 10px;
    font-size: 0.85rem;
    white-space: normal;
  }

  .name-col p {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100px;
  }
}


    .container-fluid.page-body-wrapper {
      display: flex;
      flex-direction: row;
    }

    .main-panel {
      flex-grow: 1;
      padding: 10px;
      transition: margin-left 0.3s ease;
    }

    @media (max-width: 991px) {
      .main-panel {
        margin-left: 0;
      }
    }

    .card {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
      border: none;
      overflow: hidden;
      margin-bottom: 30px;
    }

    .card-header {
      background: linear-gradient(90deg, var(--primary), var(--primary-light));
      color: white;
      padding: 20px 25px;
      font-size: 1.4rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .card-body {
      padding: 25px;
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }
    @media (max-width: 576px) {
  .toolbar {
    flex-direction: column;
    align-items: stretch;
  }

  .search-box {
    width: 100%;
  }

  .form-select {
    width: 100%;
  }
}


    .search-box {
      position: relative;
      flex: 1;
      min-width: 250px;
      max-width: 400px;
    }

    .search-box i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #9e9e9e;
    }

    .search-input {
      width: 100%;
      padding: 12px 15px 12px 45px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      background-color: #f9f9f9;
    }

    .search-input:focus {
      outline: none;
      border-color: #1a73e8;
      background-color: white;
      box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
    }

    .filter-options {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .form-select {
      padding: 10px 15px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      font-size: 0.95rem;
      background-color: #f9f9f9;
      cursor: pointer;
    }

    .btn-add {
      background: #4b49ac;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(26, 115, 232, 0.2);
    }

    .btn-add:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
    }

    .table-responsive {
      overflow-x: auto;
      border-radius: 10px;
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    
.equipment-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
}

@media (min-width: 768px) {
  .equipment-table {
    min-width: 800px;
  }
}

    .equipment-table th {
      background-color: #f5f8ff;
      color: #1a73e8;
      font-weight: 600;
      padding: 16px 20px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
      white-space: nowrap;
    }

    .equipment-table td {
      padding: 14px 20px;
      border-bottom: 1px solid #f0f0f0;
      vertical-align: middle;
    }
    .equipment-table td,
.equipment-table th {
  word-break: break-word;
}


    .equipment-table tr:hover {
      background-color: #f9fbff;
    }

    .equipment-image {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      object-fit: cover;
    }

    .category-badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      background-color: #e8f0fe;
      color: #1a73e8;
      font-weight: 500;
    }

    .quantity-display {
      position: relative;
      width: 80px;
    }

    .quantity-value {
      position: relative;
      z-index: 2;
      font-weight: 500;
    }

    .quantity-bar {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      background-color: rgba(66, 133, 244, 0.1);
      border-radius: 4px;
      z-index: 1;
      transition: width 0.5s ease;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
      white-space: nowrap;
    }

    .status-badge i {
      margin-right: 5px;
      font-size: 0.9rem;
    }

    .in-stock {
      background-color: rgba(52, 168, 83, 0.1);
      color: #34a853;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
    }
    @media (max-width: 400px) {
  .action-buttons {
    flex-direction: column;
    align-items: flex-start;
  }
}


    .btn-action {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background-color: transparent;
      color: #5f6368;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-action:hover {
      background-color: #f1f3f4;
      color: #1a73e8;
    }

    .btn-action.edit:hover {
      background-color: #fff8e1;
      color: #f9ab00;
    }

    /* Modal Styling */
    .modal {
      z-index: 1055;
    }
   
  .custom-modal-height {
    max-height: 95vh; /* You can increase or decrease as needed */
  }

  .custom-modal-height .modal-content {
    max-height: 90vh;
    overflow-y: auto;
  }
  .modal-content{
    height: 100%;
  }


    .modal-backdrop {
      z-index: 1050;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-backdrop.show {
      opacity: 0.5;
    }

    .form-card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 10px 17px;
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      animation: slideUp 0.8s ease forwards;
      max-width: 700px;
      margin: 0 auto;
    }
    @media (max-width: 768px) {
  .form-card {
    padding: 15px;
    margin: 15px;
  }
}


    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(50px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .form-header {
      background: linear-gradient(90deg, var(--primary), var(--primary-light));
      color: white;
      padding: 12px;
      border-radius: 15px;
      text-align: center;
      margin-bottom: 30px;
      font-size: 23px;
      font-weight: 600;

      position: relative;
      overflow: hidden;
    }

    .form-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: linear-gradient(145deg, transparent 4px, rgba(0,0,0,0.2), transparent);
      animation: shine 2s infinite;
    }

    @keyframes shine {
      from {
        left: -100%;
      }

      to {
        left: 100%;
      }
    }

    .form-group {
      position: relative;
      margin-bottom: 30px;
    }

    .form-control,
    .form-select {
      width: 100%;
      border: none;
      border-bottom: 2px solid var(--gray);
      background: transparent;
      padding: 12px 0;
      font-size: 1rem;
      color: var(--dark);
      transition: all 0.3s ease;
    }

    .form-control:focus,
    .form-select:focus {
      border-bottom-color: var(--primary);
      outline: none;
    }

    .form-label {
      position: absolute;
      top: 12px;
      left: 0;
      font-weight: 500;
      color: black;
      pointer-events: none;
      transition: all 0.3s ease;
    }

    .form-control:focus~.form-label,
    .form-control:not(:placeholder-shown)~ .form-label,
      .form-select:focus~ .form-select:not([value=""])~.form-label {
      top: -20px;
      left: 0;
      font-size: 0.85rem;
      color: var(--primary);
    }

    .form-control:focus~.form-label::after,
    .form-control:not(:placeholder-shown)~ .form-label::after,
      .form-select:focus~ .form-select:not([value=""])~.form-label::after {
      content: '*';
      color: var(--danger);
      color: red;
      margin-left: 5px;
    }

    .form-select option {
      background: var(--light);
      color: var(--dark);
    }

    .btn-success {
      background: linear-gradient(145deg, var(--success), var(--success-light));
      color: white;
      border-radius: none;
      padding: 9px;
      border-radius: 50px;
      font-weight: bold;
      color: white;
      width: 100%;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: auto;
    }

    .btn-success:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(108, 92, 231, 0.3);
    }

    .btn-success::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      animation: shine 2s infinite;
    }

    .error-message {
      color: var(--danger);
      font-size: 0.85rem;
      margin-top: 5px;
      display: none;
    }

    .input-error .error-message {
      display: block;
    }

    .input-error .form-control,
    .form-control .input-error .form-select {
      border-color: var(--danger);
    }

    .form-icon {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
      transition: color 0.3s ease;
    }

    .form-control:focus~.form-icon,
    .form-select:focus~.form-icon {
      color: var(--primary);
    }

    /* Table Footer */
    .table-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding: 15px 10px;
      font-size: 0.9rem;
      color: #5f6368;
    }

    .showing-entries {
      color: #5f6368;
    }

    .pagination {
      display: flex;
      gap: 5px;
    }

    .page-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #e0e0e0;
      background-color: white;
      color: #5f6368;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
    }

    .page-btn:hover {
      background-color: #f1f3f4;
    }

    .page-btn.active {
      background-color: #1a73e8;
      color: white;
      border-color: #1a73e8;
    }

    .page-btn.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    @media (max-width: 330px) {
      .btn-add {
        padding: 10px 15px;
        font-size: 13px;
      }

      .btn-add i {
        font-size: 12px;
      }
    }

    @media (max-width: 307px) {
      .btn-add {
        padding: 12px 10px;
        font-size: 13px;
      }

      .btn-add i {
        font-size: 12px;
      }
    }

    @media (max-width: 300px) {
      .btn-add {
        padding: 11px 14px;
        font-size: 11px;
        gap: 2px;
      }
    }

    .equipment-info {
      border: 0px solid #cccccc00;
      border-radius: 6px;
      display: inline-block;
    }

    .equipment-info:focus,
    .equipment-info:active,
    .equipment-info:focus-within {
      border: 0px solid #cccccc00;
      outline: none;
    }
    @media (max-width: 576px) {
  .modal-dialog {
    margin: 10px;
    width: auto;
  }
}


    /* Print-specific styles */
    @media print {
      .no-print {
        display: none !important;
      }
    }
    html {
  font-size: 100%;
}

@media (max-width: 576px) {
  html {
    font-size: 90%;
  }
}
@media (max-width: 768px) {
  .equipment-table {
    min-width: 100%;
    font-size: 0.9rem;
  }

  .equipment-table th,
  .equipment-table td {
    padding: 10px 12px;
  }
}

@media (max-width: 530px) {
  html, body {
    overflow-x: hidden !important;
  }

  .equipment-table {
    width: 100% !important;
    min-width: unset !important;
    table-layout: auto !important;
    font-size: 0.78rem !important;
  }

  .equipment-table th,
  .equipment-table td {
    padding: 6px 6px !important;
    word-break: break-word;
    white-space: normal;
  }

  .name-col p {
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .action-buttons {
    flex-direction: column;
    gap: 4px;
    align-items: flex-start;
  }

  .action-buttons .btn {
    width: 34px !important;
    height: 34px !important;
    padding: 5px !important;
    font-size: 0.9rem !important;
    justify-content: center;
  }

  .action-buttons .btn i {
    font-size: 1rem !important;
    display: inline-block !important;
  }

  .receipt-btn {
    width: 34px !important;
    height: 34px !important;
    padding: 5px !important;
  }
}

  </style>
</head>
<body style="background-color: #F3F3F9;">
  <div class="container-scroller">
    <!-- Navbar Partial -->
    <%- include ('../partials/_navbar.ejs') %>
    <div class="container-fluid page-body-wrapper" style="padding-left: 0 !important; padding-right: 0 !important;">
      <!-- Sidebar Start -->
      <%- include ('../partials/Sidebar.ejs') %>
      <!-- Sidebar End -->
      <div class="main-panel" style="width: 100%;">
        <div class="content-wrapper">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <i class="bi bi-clock-history"></i> History
              <div class="header-actions d-flex align-items-center gap-3">
                <input type="date" id="filterFromDate" class="form-control form-control-sm" placeholder="From Date" />
                <input type="date" id="filterToDate" class="form-control form-control-sm" placeholder="To Date" />
                <button id="filterBtn" class="btn btn-primary btn-sm">Filter</button>
                <button id="clearFilterBtn" class="btn btn-secondary btn-sm">Clear</button>
              </div>
            </div>
            <div class="card-body">
              <div class="toolbar"></div>
              <div class="table-responsive">
                <table class="equipment-table" id="historyTable">
                  <thead>
                    <tr>
                      <th class="name-col">#</th>
                      <th class="name-col">Package Name</th>
                      <th class="type-col">Paid %</th>
                      <th class="category-col">Invoice</th>
                      <th class="quantity-col">Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% packages.forEach((package, index) => { 
                      let result = 0;
                      if (package.amount && package.custom_amount) {
                        if (package.custom_amount >= package.amount) {
                          result = 100;
                        } else {
                          result = (package.custom_amount * 100) / package.amount;
                        }
                      }
                      if (result > 0 && index !== 1) { %>
                    <tr data-accepted="<%= package.Accepted %>">
                      <td class="name-col"><%= index + 1 %></td>
                      <td class="name-col">
                        <p class="text-black"
                          onclick="document.getElementById('receipt-<%= package.transaction_id %>').click(); return false;"
                          style="font-size: 1.1rem; margin: 0 !important;">
                          package_name - <%= package.package_name %>
                        </p>
                      </td>
                      <td class="type-col">
                        <span class="category-badge">
                          <strong><%= result.toFixed(2) %>%</strong>
                        </span>
                      </td>
                      <td class="category-col">
                        <span class="badge" style="background-color: #dcf1e2; color: #20754d;"> paid</span>
                      </td>
                      <td class="quantity-col">
                        <div class="d-flex align-items-center gap-2">
                          <button class="btn btn-sm receipt-btn btn-outline-success p-2 d-flex align-items-center justify-content-center"
                            data-transaction-id="<%= package.transaction_id %>"
                            data-package-name="<%= package.package_name %>"
                            data-accepted="<%= package.Accepted %>"
                            data-amount="<%= package.amount %>"
                            data-coins="<%= package.coins %>"
                            data-discount="<%= package.discount %>"
                            data-remaining="<%= package.remaining_amount %>"
                            data-custom-amount="<%= package.custom_amount %>"
                            style="width: 40px; height: 40px;">
                           <i class="fas fa-file-invoice fs-5 text-primary" title="View Invoice"></i>
                          </button>
                          <button type="button" class="btn btn-sm btn-outline-danger p-2 d-flex align-items-center justify-content-center"
                            style="width: 40px; height: 40px;"
                            onclick="deletePackage('<%= package.id %>', this)">
                            <i class="fas fa-trash-alt"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                    <% } }) %>

<script>
  function deletePackage(id, btn) {
    if (!confirm('Are you sure you want to delete this package?')) {
      return;
    }
    fetch('/delete-package', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: new URLSearchParams({ id: id })
    })
    .then(response => {
      if (response.ok) {
        // Remove the row from the table
        const row = btn.closest('tr');
        if (row) {
          row.remove();
        }
      } else {
        alert('Failed to delete package.');
      }
    })
    .catch(error => {
      console.error('Error deleting package:', error);
      alert('Error deleting package.');
    });
  }
</script>
                  </tbody>
                </table>
              </div>
              <script>
                function deletePackage(id, btn) {
                  if (!confirm('Are you sure you want to delete this package?')) {
                    return;
                  }
                  fetch('/delete-package', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id })
                  })
                  .then(response => {
                    if (response.ok) {
                      // Remove the row from the table
                      const row = btn.closest('tr');
                      if (row) {
                        row.remove();
                      }
                    } else {
                      alert('Failed to delete package.');
                    }
                  })
                  .catch(error => {
                    console.error('Error deleting package:', error);
                    alert('Error deleting package.');
                  });
                }
              </script>

              <!-- Subscribed Packages Table -->
              <% /* Removed subscribed packages separate table and filter as per user request */ %>
              <% /* Merging subscribedPackages into packages table below */ %>
              <% subscribedPackages.forEach(subPackage => { %>
                <% if ((subPackage.custom_amount * 100) / subPackage.amount === 100) { %>
                  <% packages.push(subPackage); %>
                <% } %>
              <% }); %>
              <!-- The packages table already displays all packages including subscribed ones with 100% paid -->
            </div>
            
            
           <script>
  // ================== HISTORY FILTER ==================
  document.getElementById('filterBtn').addEventListener('click', function () {
    const fromDateStr = document.getElementById('filterFromDate').value;
    const toDateStr = document.getElementById('filterToDate').value;

    const fromDate = fromDateStr ? new Date(fromDateStr) : null;
    const toDate = toDateStr ? new Date(toDateStr) : null;

    const rows = document.querySelectorAll('#historyTable tbody tr');

    rows.forEach(row => {
      const acceptedDateStr = row.getAttribute('data-accepted');
      const acceptedDate = new Date(acceptedDateStr);

      let show = true;

      if (fromDate && acceptedDate < fromDate) show = false;
      if (toDate && acceptedDate > toDate) show = false;

      row.style.display = show ? '' : 'none';
    });
  });

  document.getElementById('clearFilterBtn').addEventListener('click', function () {
    document.getElementById('filterFromDate').value = '';
    document.getElementById('filterToDate').value = '';
    const rows = document.querySelectorAll('#historyTable tbody tr');
    rows.forEach(row => row.style.display = '');
  });

  // ================== SUBSCRIBED PACKAGES FILTER ==================
  document.getElementById('subscribedFilterBtn')?.addEventListener('click', function () {
    const fromDateStr = document.getElementById('subscribedFromDate').value;
    const toDateStr = document.getElementById('subscribedToDate').value;

    const fromDate = fromDateStr ? new Date(fromDateStr) : null;
    const toDate = toDateStr ? new Date(toDateStr) : null;

    const rows = document.querySelectorAll('#subscribedPackagesTable tbody tr');

    rows.forEach(row => {
      const createdDateStr = row.getAttribute('data-created');
      const expiryDateStr = row.getAttribute('data-expiry');

      const createdDate = new Date(createdDateStr);
      const expiryDate = new Date(expiryDateStr);

      let show = true;

      // Check if package start & expiry dates are within filter range
      if (fromDate && expiryDate < fromDate) show = false;
      if (toDate && createdDate > toDate) show = false;

      row.style.display = show ? '' : 'none';
    });
  });

  document.getElementById('subscribedClearFilterBtn')?.addEventListener('click', function () {
    document.getElementById('subscribedFromDate').value = '';
    document.getElementById('subscribedToDate').value = '';
    const rows = document.querySelectorAll('#subscribedPackagesTable tbody tr');
    rows.forEach(row => row.style.display = '');
  });
</script>

          </div>
        </div>
      </div>
    </div>

    <!-- Invoice Modal -->
    <div class="modal fade " style="top: -90px; position: absolute; margin-bottom: 30px; height: 100%;" id="invoiceModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered custom-modal-height">
 
        <div class="modal-content border-0 shadow">
          <div class="modal-header bg-gradient-primary text-white">
            <h5 class="modal-title fw-bold"><i class="fas fa-file-invoice me-2"></i> INVOICE</h5>
      <button type="button" class="btn-close text-danger " data-bs-dismiss="modal" aria-label="Close" style="  padding: 4px;  filter: invert(29%) sepia(91%) saturate(7484%) hue-rotate(356deg) brightness(89%) contrast(110%);"></button>











          </div>
          <div class="modal-body  p-0">
            <div id="printArea">
              <div class="container my-1 position-relative" style="background-color: #f8f9fa;">
                <!-- Top Logo and Buttons -->
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 rounded"
                  style="background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);">
                  <img src="/images/ClickTake.png" alt="Falcon Logo" class="logo"
                    style="height: 50px; filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.2));">
                  <div >
                    <button style="overflow: hidden;" class="btn btn-success me-2 shadow-sm no-print" onclick="downloadInvoice()">
                      <i class="fas fa-download me-1"></i> Download Invoice
                    </button>
     <button class="btn btn-primary mt-1 shadow-sm no-print" onclick="emailInvoice()">
    <i class="fas fa-envelope me-1"></i> Email Invoice
  </button>
</div>
                </div>
                <hr class="border-2 border-top" style="border-color: #4e73df!important; opacity: 0.7;">
                <!-- Invoice Info -->
                <div class="row mb-2 p-2 rounded" style="background-color: #fff; border-left: 4px solid #4e73df;">
                  <div class="col-md-6">
                    <h5 class="text-uppercase text-info mb-3"><i class="fas fa-user-circle me-2"></i> INVOICE TO:</h5>
                    <p class="mb-1"><strong>Click Optics</strong> (<span id="i-username" class="text-primary">Username</span>)</p>
                    <p class="mb-1 text-muted"><i class="fas fa-map-marker-alt me-2"></i> <span id="i-address">Rid</span></p>
                  </div>
                  <div class="col-md-6 text-md-end">
                    <h5 class="mb-2"><span class="badge bg-primary p-2">INVOICE # P<span id="i-invoice-no">51717</span></span></h5>
                    <p class="mb-1"><i class="far fa-calendar-alt me-2 text-info"></i> <strong>Date:</strong> <span id="i-date" class="text-dark">may 00, 0000</span></p>
                    <p class="mb-1"><i class="fas fa-wallet me-2 text-info"></i> <strong>Payment Method:</strong> <span class="badge bg-danger" id="i-payment-method">Due</span></p>
                    <p class="mb-0"><i class="fas fa-file-invoice me-2 text-info"></i> <strong>Invoice Type:</strong> <span class="badge bg-secondary">Regular Invoice</span></p>
                  </div>
                </div>
                <!-- Invoice Table -->
                <div class="table-responsive">
                  <table class="table table-bordered table-hover">
                    <thead class="bg-light-primary text-dark">
                      <tr>
                        <th class="text-center">#</th>
                        <th>Package Name</th>
                        <th>Next Expiry</th>
                        <th class="text-end">Price</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td class="text-center">01</td>
                        <td id="i-package-name" class="fw-bold">P-10-MB</td>
                        <td id="i-expiry-date" class="text-success fw-bold">00, May 0000 00:00 PM</td>
                        <td id="i-amount" class="text-end fw-bold">00.00</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <!-- Totals -->
                <div class="d-flex justify-content-end mt-2">
                  <table class="table table-bordered w-auto shadow-sm">
                    <tr class="bg-light-warning">
                      <td class="fw-bold">DISCOUNT:</td>
                      <td class="text-end fw-bold text-success" id="i-discount">0.00</td>
                    </tr>
                    <tr class="bg-light-info">
                      <td class="fw-bold">COINS USED:</td>
                      <td class="text-end fw-bold text-info" id="i-coins">0.00</td>
                    </tr>
                    <tr class="bg-light-success">
                      <td class="fw-bold">Paid Amount:</td>
                      <td class="text-end fw-bold text-success" id="i-paid-amount">0.00</td>
                    </tr>
                    <tr class="bg-light-danger">
                      <td class="fw-bold">Remaining Amount:</td>
                      <td class="text-end fw-bold text-danger" id="i-remaining-amount">0.00</td>
                    </tr>
                    <tr class="bg-primary text-white">
                      <th class="fw-bold fs-5">GRAND TOTAL:</th>
                      <th class="text-end fs-5" id="i-grand-total">00.00</th>
                    </tr>
                  </table>
                </div>
                <!-- Thank You and Notice -->
                <div class="mt-2 p-2 rounded" style="background-color: #f8f9fa; border-top: 3px solid #4e73df;">
                  <p class="fw-bold text-center text-primary mb-4" style="font-size: 1.2rem;">
                    <i class="fas fa-heart text-danger me-2"></i> Thank you for your business!
                  </p>
                  <div class="alert alert-warning text-center">
                    <strong><i class="fas fa-exclamation-circle me-2"></i>NOTICE:</strong> Please pay your unpaid bill
                    within next 7 days for uninterrupted internet services.<br>
                    Invoice was created on a computer and is valid without the signature and seal.
                  </div>
                  <div class="text-center text-muted small mt-3">
                    <i class="fas fa-lock me-1"></i> Secure Payment Invoice | <i class="fas fa-shield-alt me-1"></i>
                    Protected Content
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- JS for Receipt and Date Filtering -->
    <script>
      // Verify html2pdf.js is loaded
      if (typeof html2pdf === 'undefined') {
        console.error('html2pdf.js is not loaded');
      } else {
        console.log('html2pdf.js is loaded');
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Format Sent Dates
        document.querySelectorAll(".i-date").forEach(span => {
          const rawDate = span.dataset.date;
          const date = new Date(rawDate);
          const formatted = date.toLocaleString('en-US', {
            timeZone: 'Asia/Karachi',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
          });
          span.textContent = formatted;
        });

        // Receipt Modal Logic
        document.querySelectorAll(".receipt-btn").forEach(button => {
          button.addEventListener("click", function () {
            const transactionId = this.dataset.transactionId;
            const packageName = this.dataset.packageName;
            const amount = parseFloat(this.dataset.amount);
            const discount = parseFloat(this.dataset.discount) || 0;
            const coins = parseFloat(this.dataset.coins) || 0;
            const paidAmount = parseFloat(this.dataset.customAmount) || 0;
            const remainingAmount = parseFloat(this.dataset.remaining) || 0;

            const invoiceDate = new Date().toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'numeric',
              day: 'numeric'
            });

            const expiryDate = new Date();
            expiryDate.setDate(expiryDate.getDate() + 30);
            const formattedExpiry = expiryDate.toLocaleDateString('en-US', {
              day: 'numeric',
              month: 'short',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });

           document.getElementById("i-invoice-no").textContent = this.closest("tr").querySelector("input[name='id']")?.value || "0";

            document.getElementById("i-date").textContent = invoiceDate;
            document.getElementById("i-package-name").textContent = packageName;
            document.getElementById("i-expiry-date").textContent = formattedExpiry;
            document.getElementById("i-amount").textContent = amount.toFixed(2);
            document.getElementById("i-discount").textContent = `${discount.toFixed(2)}%`;
            document.getElementById("i-coins").textContent = coins.toFixed(2);
            document.getElementById("i-paid-amount").textContent = paidAmount.toFixed(2);
            document.getElementById("i-grand-total").textContent = (paidAmount + remainingAmount).toFixed(2);
            document.getElementById("i-remaining-amount").textContent = remainingAmount.toFixed(2);

            const invoiceModal = new bootstrap.Modal(document.getElementById('invoiceModal'));
            invoiceModal.show();
          });
        });

        // Filter by From/To Date
      document.getElementById("filterBtn")?.addEventListener("click", function () {
          const fromDateStr = document.getElementById("filterFromDate").value;
          const toDateStr = document.getElementById("filterToDate").value;
          const rows = document.querySelectorAll('#historyTable tbody tr');

          if (!fromDateStr || !toDateStr) {
            alert("Please select both From Date and To Date to filter.");
            return;
          }

          if (moment(fromDateStr, 'YYYY-MM-DD').isAfter(moment(toDateStr, 'YYYY-MM-DD'))) {
            alert("From Date cannot be later than To Date.");
            return;
          }

          rows.forEach(row => {
            const acceptedDateStr = row.getAttribute('data-accepted');
            if (!acceptedDateStr) {
              row.style.display = 'none';
              return;
            }
            const acceptedDate = moment(acceptedDateStr, 'YYYY-MM-DD');
            const fromDate = moment(fromDateStr, 'YYYY-MM-DD');
            const toDate = moment(toDateStr, 'YYYY-MM-DD');

            if (acceptedDate.isSameOrAfter(fromDate) && acceptedDate.isSameOrBefore(toDate)) {
              row.style.display = '';
            } else {
              row.style.display = 'none';
            }
          });
        });
      });

      function downloadInvoice() {
        const element = document.getElementById("printArea");
        const downloadButton = document.querySelector('.btn-success.me-2');

        if (!element) {
          console.error('printArea element not found');
          alert('Error: Could not find invoice content to generate PDF.');
          return;
        }

        if (downloadButton) {
          downloadButton.style.display = 'none';
        }
        

        const opt = {
          margin: 0.5,
          filename: `invoice_${document.getElementById("i-invoice-no").textContent}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2, useCORS: true },
          jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
        };

        html2pdf()
          .set(opt)
          .from(element)
          .save()
          .then(() => {
            if (downloadButton) {
              downloadButton.style.display = '';
            }
          })
          .catch(error => {
            console.error('PDF generation failed:', error);
            alert('Failed to generate PDF. Please try again or contact support.');
            if (downloadButton) {
              downloadButton.style.display = '';
            }
          });
      }
      
function emailInvoice() {
  const invoiceId = document.getElementById("i-invoice-no").textContent;

  fetch(`/email-invoice/${invoiceId}`)
    .then(res => res.text())
    .then(msg => {
      alert(msg);
    })
    .catch(err => {
      console.error("Failed to send invoice email:", err);
      alert("Failed to send invoice email.");
    });
}


    </script>

    <!-- Plugins:js -->
    <script src="vendors/js/vendor.bundle.base.js"></script>
    <!-- Plugin js for this page -->
    <script src="vendors/chart.js/Chart.min.js"></script>
    <script src="vendors/datatables.net/jquery.dataTables.js"></script>
    <script src="vendors/datatables.net-bs4/dataTables.bootstrap4.js"></script>
    <script src="js/dataTables.select.min.js"></script>
    <!-- Inject:js -->
    <script src="js/off-canvas.js"></script>
    <script src="js/hoverable-collapse.js"></script>
    <script src="js/template.js"></script>
    <script src="js/settings.js"></script>
    <!-- Custom js for this page -->
    <script src="js/dashboard.js"></script>
    <script src="js/Chart.roundedBarCharts.js"></script>
    <!-- Bootstrap 5 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- html2pdf Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <%- include('../partials/_footer.ejs') %>
</body>
</html>